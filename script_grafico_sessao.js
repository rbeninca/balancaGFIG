const{keys:A}=Object;function _(C,_b,_c=!1){if(C.length!==_b.length||C.length<2)return{areaTotal:0,areaPositiva:0,areaNegativa:0,impulsoTotal:0,impulsoLiquido:0,impulsoPositivo:0,tempoIgnicao:0,tempoBurnout:0,forcaMaxima:0,forcaMedia:0,duracaoQueima:0,forcaMediaPositiva:0};let _d=0,_e=0,_f=0,_g=null,_h=null,_i=Math.max(..._b),J=_b.reduce((a,b)=>a+b,0)/_b.length,K=Math.max(_i*0.05,0.5),M=_e,N=_e-_f,O=L>0?M/L:0,_p=(()=>{let _A=_b.filter(f=>f>0);return _A.length?(_A.reduce((a,b)=>a+b,0)/_A.length):0})();for(let i=0;i<C.length-1;i++){const _a=C[i+1]-C[i],_B=_c?Math.max(0,_b[i]):_b[i],_C=_c?Math.max(0,_b[i+1]):_b[i+1],_D=_a*(_B+_C)/2;_d+=_D;_D>=0?_e+=_D:_f+=-_D;(_g===null&&_b[i]>K)&&(_g=C[i]);_b[i]>K&&(_h=C[i])}let L=(_h??0)-(_g??0);return{areaTotal:_e+_f,areaPositiva:_e,areaNegativa:_f,impulsoTotal:M,impulsoLiquido:N,impulsoPositivo:M,tempoIgnicao:_g||0,tempoBurnout:_h||0,duracaoQueima:L,forcaMaxima:_i,forcaMedia:J,forcaMediaPositiva:_p,forcaMediaQueima:O}}function B(aO,aP=null){let aQ=aO.impulsoTotal,{duracaoQueima:aR,forcaMaxima:_E}=aO,_F=D(aQ),_G=aP?aQ/(aP*9.81):null,_H=aR>0?aQ/aR:0,_I=_E>0?(_H/_E)*100:0;return{classificacaoMotor:_F,impulsoEspecifico:_G,razaoImpulsoMedio:_H,eficienciaQueima:_I}}function D(aS){let aT=1e-6,aU=[{min:0.00,max:0.3125,classe:'Micro 1/8A',tipo:'FM (foguetemodelo)',nivel:'Micro',cor:'#8e44ad'},{min:0.3126,max:0.625,classe:'¬ºA',tipo:'FM (foguetemodelo)',nivel:'Baixa pot√™ncia',cor:'#9b59b6'},{min:0.626,max:1.25,classe:'¬ΩA',tipo:'FM (foguetemodelo)',nivel:'Baixa pot√™ncia',cor:'#e74c3c'},{min:1.26,max:2.50,classe:'A',tipo:'FM (foguetemodelo)',nivel:'Baixa pot√™ncia',cor:'#e67e22'},{min:2.51,max:5.00,classe:'B',tipo:'FM (foguetemodelo)',nivel:'Baixa pot√™ncia',cor:'#f39c12'},{min:5.01,max:10.00,classe:'C',tipo:'FM (foguetemodelo)',nivel:'Baixa pot√™ncia',cor:'#f1c40f'},{min:10.01,max:20.00,classe:'D',tipo:'FM (foguetemodelo)',nivel:'Baixa pot√™ncia',cor:'#2ecc71'},{min:20.01,max:40.00,classe:'E',tipo:'FM (foguetemodelo)',nivel:'M√©dia pot√™ncia',cor:'#1abc9c'},{min:40.01,max:80.00,classe:'F',tipo:'FM (foguetemodelo)',nivel:'M√©dia pot√™ncia',cor:'#3498db'},{min:80.01,max:160.00,classe:'G',tipo:'FM (foguetemodelo)',nivel:'M√©dia pot√™ncia',cor:'#9b59b6'},{min:160.01,max:320.00,classe:'H',tipo:'MFE (experimental)',nivel:'N√≠vel 1',cor:'#e74c3c'},{min:320.01,max:640.00,classe:'I',tipo:'MFE (experimental)',nivel:'N√≠vel 1',cor:'#e67e22'},{min:640.01,max:1280.00,classe:'J',tipo:'MFE (experimental)',nivel:'N√≠vel 2',cor:'#f39c12'},{min:1280.01,max:2560.00,classe:'K',tipo:'MFE (experimental)',nivel:'N√≠vel 2',cor:'#2ecc71'},{min:2560.01,max:5120.00,classe:'L',tipo:'MFE (experimental)',nivel:'N√≠vel 2',cor:'#3498db'},{min:5120.01,max:10240.00,classe:'M',tipo:'MFE (experimental)',nivel:'N√≠vel 3',cor:'#9b59b6'},{min:10240.01,max:20480.00,classe:'N',tipo:'MFE (experimental)',nivel:'N√≠vel 3',cor:'#e74c3c'},{min:20480.01,max:40960.00,classe:'O',tipo:'MFE (experimental)',nivel:'N√≠vel 3',cor:'#c0392b'}],c=aU.find(c=>aS>=(c.min-aT)&&aS<=(c.max+aT));if(!c)return{classe:'Indefinido',tipo:'‚Äî',nivel:'‚Äî',cor:'#95a5a6',faixa:'N/A'};return{classe:c.classe,tipo:c.tipo,nivel:c.nivel,cor:c.cor,faixa:`${c.min.toFixed(2)} a ${c.max.toFixed(2)} N‚ãÖs`}}let E=!1;function F(){return{escala:parseInt(localStorage.getItem('png_escala'))||1,tema:localStorage.getItem('png_tema')||'profissional',template:localStorage.getItem('png_template')||'completo',tamanho:localStorage.getItem('png_tamanho')||'medio',mostrarLogo:localStorage.getItem('png_logo')!=='false',logoTexto:localStorage.getItem('png_logo_texto')||'GFIG',logoPos:localStorage.getItem('png_logo_pos')||'canto-superior-direito',formato:localStorage.getItem('png_formato')||'png',qualidadeJPEG:parseFloat(localStorage.getItem('png_qualidade'))||0.95,debug:localStorage.getItem('png_debug')==='true'}}function G(aV){for(const aW of A(aV))localStorage.setItem(`png_${aW}`,aV[aW])}function H(aX){let aY={profissional:{fundo:'#ffffff',titulo:'#2c3e50',subtitulo:'#7f8c8d',azul:'#3498db',verde:'#27ae60',vermelho:'#e74c3c',cinza:'#95a5a6',fundo2:'#f8f9fa',laranja:'#e67e22'},cientifico:{fundo:'#f5f5f5',titulo:'#1a1a1a',subtitulo:'#666666',azul:'#0066cc',verde:'#006600',vermelho:'#cc0000',cinza:'#888888',fundo2:'#e8e8e8',laranja:'#cc6600'},foguete:{fundo:'#0a0e27',titulo:'#ffffff',subtitulo:'#b0b0b0',azul:'#ff6b35',verde:'#f7931e',vermelho:'#c1121f',cinza:'#7a7a7a',fundo2:'#1a1e37',laranja:'#ffa500'}};return aY[aX]||aY.profissional}function I(aZ){let bA={pequeno:{w:1200,h:900},medio:{w:1600,h:1200},grande:{w:2400,h:1800},A4:{w:2480,h:3508}};return bA[aZ]||bA.medio}function j(){if(typeof showNotification!=='function'){E&&console.warn('[PNG] showNotification n√£o definida, usando console.log como fallback');window.showNotification=(bB,bC,bD)=>console.log(`[${bB.toUpperCase()}] ${bC}`)}}function k(){try{let bE=F(),bF=document.getElementById('config-png-tema'),bG=document.getElementById('config-png-escala'),bH=document.getElementById('config-png-tamanho'),bI=document.getElementById('config-png-formato'),bJ=document.getElementById('config-png-logo'),bK=document.getElementById('config-png-logo-texto'),bL=document.getElementById('config-png-logo-pos');bF&&(bF.value=bE.tema);bG&&(bG.value=bE.escala);bH&&(bH.value=bE.tamanho);bI&&(bI.value=bE.formato);bJ&&(bJ.checked=bE.mostrarLogo);bK&&(bK.value=bE.logoTexto);bL&&(bL.value=bE.logoPos);E&&console.log('[PNG] Configura√ß√µes carregadas na interface:',bE)}catch(e){console.error('[PNG] Erro ao carregar configura√ß√µes na interface:',e)}}function l(){try{let bM={tema:document.getElementById('config-png-tema').value,escala:document.getElementById('config-png-escala').value,tamanho:document.getElementById('config-png-tamanho').value,formato:document.getElementById('config-png-formato').value,logo:document.getElementById('config-png-logo').checked?'true':'false',logo_texto:document.getElementById('config-png-logo-texto').value,logo_pos:document.getElementById('config-png-logo-pos').value};G(bM);showNotification('success','‚úÖ Configura√ß√µes PNG salvas com sucesso!');E&&console.log('[PNG] Configura√ß√µes salvas:',bM)}catch(e){console.error('[PNG] Erro ao salvar configura√ß√µes:',e);showNotification('error','Erro ao salvar configura√ß√µes: '+e.message)}}function m(){try{localStorage.removeItem('png_tema');localStorage.removeItem('png_escala');localStorage.removeItem('png_tamanho');localStorage.removeItem('png_formato');localStorage.removeItem('png_logo');localStorage.removeItem('png_logo_texto');localStorage.removeItem('png_logo_pos');k();showNotification('info','üîÑ Configura√ß√µes resetadas para o padr√£o');E&&console.log('[PNG] Configura√ß√µes resetadas')}catch(e){console.error('[PNG] Erro ao resetar configura√ß√µes:',e)}}function n(){try{let bN={tema:document.getElementById('config-png-tema').value,escala:document.getElementById('config-png-escala').value,tamanho:document.getElementById('config-png-tamanho').value,formato:document.getElementById('config-png-formato').value},bO=I(bN.tamanho),bP=bO.w*bN.escala;showNotification('info',`
üìä Preview das Configura√ß√µes PNG:

üé® Tema: ${bN.tema.charAt(0).toUpperCase()+bN.tema.slice(1)}
üìê Resolu√ß√£o: ${bN.escala}x (${bP}x${bO.h*bN.escala} pixels)
üìè Tamanho Base: ${bN.tamanho} (${bO.w}x${bO.h})
üíæ Formato: ${bN.formato.toUpperCase()}

üí° Tamanho aproximado do arquivo:
- 1x: ~200-500 KB
- 2x: ~800 KB - 2 MB
- 4x: ~3-8 MB
    `.trim(),8000)}catch(e){console.error('[PNG] Erro no preview:',e)}}typeof document!=='undefined'&&document.addEventListener('DOMContentLoaded',function(){k()});function o(bQ,bR=!1){console.log('[PNG] exportarImagemSessao chamada! SessionID:',bQ);j();if(bR)E&&console.log('[PNG] Modal de configura√ß√£o ainda n√£o implementado, usando configura√ß√£o padr√£o');let bS=F();console.log('[PNG] Configura√ß√£o obtida:',bS);P(bQ,bS)}function P(bT,bU){let bV=bU.debug?performance.now():0;try{bU.debug&&console.log('[PNG] Iniciando exporta√ß√£o...',{sessionId:bT,config:bU});let bW=JSON.parse(localStorage.getItem('balancaGravacoes'))||[],bX=bW.find(g=>g.id===bT);if(!bX||!bX.dadosTabela||bX.dadosTabela.length===0){showNotification('error','Sess√£o n√£o encontrada ou sem dados');return}showNotification('info',`Gerando an√°lise de propuls√£o de "${bX.nome}"...`,2000);let bY=q(bX.dadosTabela);bU.debug&&console.log('[PNG] Dados processados:',{pontos:bY.pontos,impulso:bY.impulso.impulsoTotal,classe:bY.propulsao.classificacaoMotor.classe});r(bX,bY,bU);if(bU.debug){let bZ=performance.now()-bV;console.log(`[PNG] Exporta√ß√£o conclu√≠da em ${bZ.toFixed(0)}ms`)}}catch(e){console.error('[PNG] Erro na exporta√ß√£o:',e);showNotification('error','Erro ao gerar relat√≥rio: '+e.message)}}function q(cA){let cB=[],cC=[],cD=[],cF=B(cE);for(const cG of cA){cB.push(parseFloat(cG.tempo_esp)||0);cC.push(parseFloat(cG.newtons)||0);cD.push(parseFloat(cG.quilo_forca)||0)}let cE=_(cB,cC,!1);return{tempos:cB,newtons:cC,kgf:cD,stats:(cU=>{return{media:cW,max:cX,min:cY,mediana:dA,desvio:dB,cv:dC,amplitude:cX-cY}})(cD),duracao:cB.length>0?Math.max(...cB)-Math.min(...cB):0,pontos:cB.length,impulso:cE,propulsao:cF}}function r(dF,dG,dH){try{let dI=document.createElement('canvas'),dJ=dI.getContext('2d'),dK=I(dH.tamanho),w=dK.w,h=dK.h,dL=dH.escala||1,dN=new Date(dF.timestamp).toLocaleString('pt-BR'),_j=dG.propulsao.classificacaoMotor;dI.width=w*dL;dI.height=h*dL;if(dL>1){dJ.scale(dL,dL);dH.debug&&console.log(`[PNG] Canvas escalado ${dL}x: ${dI.width}x${dI.height}`)}let dM=H(dH.tema);dH.debug&&console.log(`[PNG] Usando tema "${dH.tema}" e tamanho "${dH.tamanho}"`);dJ.fillStyle=dM.fundo;dJ.fillRect(0,0,w,h);dJ.fillStyle=dM.titulo;dJ.font='bold 36px Arial';dJ.textAlign='center';dJ.fillText('üöÄ AN√ÅLISE DE PROPULS√ÉO',w/2,50);dJ.fillStyle=dM.azul;dJ.font='bold 24px Arial';dJ.fillText(`"${dF.nome}"`,w/2,90);dJ.fillStyle=dM.subtitulo;dJ.font='16px Arial';dJ.fillText(`Teste realizado em: ${dN}`,w/2,120);dJ.fillStyle=dM.verde;dJ.font='bold 20px Arial';let dO=dG.impulso.impulsoTotal;dJ.fillText(`üí• Impulso Total: ${dO.toFixed(2)} N‚ãÖs | Motor Classe ${_j.classe}`,w/2,155);dJ.strokeStyle=dM.cinza;dJ.lineWidth=2;dJ.beginPath();dJ.moveTo(w*0.1,180);dJ.lineTo(w*0.9,180);dJ.stroke();dH.mostrarLogo&&S(dJ,dH,dM,w,h);dG.kgf.length>0&&v(dJ,dG,dM,w,h);dG.stats&&W(dJ,dG,dM,w,h);X(dJ,dG,dM,w,h);dJ.fillStyle=dM.subtitulo;dJ.font='12px Arial';dJ.textAlign='left';dJ.fillText('Sistema de An√°lise de Propuls√£o - GFIG',50,h-20);dJ.textAlign='right';dJ.fillText(`Gerado em: ${new Date().toLocaleString('pt-BR')}`,w-50,h-20);t(dI,dF.nome+'_analise_propulsao',dH)}catch(e){console.error('[PNG] Erro ao criar relat√≥rio:',e);throw e}}function S(dP,dQ,dR,w,h){try{let x,y;switch(dQ.logoPos) {case 'canto-superior-direito':x=w-150;y=30;break;case 'canto-inferior-direito':x=w-150;y=h-50;break;case 'centro-cabecalho':x=w/2;y=30;break;default:x=w-150;y=30}dP.save();dP.globalAlpha=0.4;dP.fillStyle=dR.cinza;dP.font='20px Arial';dP.textAlign='right';dP.fillText(dQ.logoTexto||'GFIG',x,y);dP.restore()}catch(e){dQ.debug&&console.warn('[PNG] Erro ao desenhar logo:',e)}}function t(dS,dT,dU){try{let dV=dU.formato||'png';showNotification('info','Gerando arquivo...',1000);let dW={png:'image/png',jpeg:'image/jpeg',webp:'image/webp'};dS.toBlob(function(dX){if(!dX){showNotification('error','Erro ao criar arquivo');return}let dY=URL.createObjectURL(dX),dZ=document.createElement('a'),eA=dT.replace(/[^\d\sA-Za-z]/g,'').replace(/\s+/g,'_'),eB=dV==='jpeg'?'jpg':dV;dZ.download=`relatorio_${eA}_${Date.now()}.${eB}`;dZ.href=dY;document.body.appendChild(dZ);dZ.click();document.body.removeChild(dZ);setTimeout(()=>URL.revokeObjectURL(dY),1000);showNotification('success',`Relat√≥rio exportado em ${dV.toUpperCase()}!`)},dW[dV]||dW.png,dV==='png'?1.0:(dU.qualidadeJPEG||0.95))}catch(e){console.error('[PNG] Erro no download:',e);showNotification('error','Erro ao baixar: '+e.message)}}function u(eC,eD){let eE=document.createElement('canvas'),eF=eE.getContext('2d'),w=1600,h=1200,eH=new Date(eC.timestamp).toLocaleString('pt-BR'),_J=eD.propulsao.classificacaoMotor;eE.width=w;eE.height=h;let eG={fundo:'#ffffff',titulo:'#2c3e50',subtitulo:'#7f8c8d',azul:'#3498db',verde:'#27ae60',vermelho:'#e74c3c',cinza:'#95a5a6',fundo2:'#f8f9fa',laranja:'#e67e22'};eF.fillStyle=eG.fundo;eF.fillRect(0,0,w,h);eF.fillStyle=eG.titulo;eF.font='bold 36px Arial';eF.textAlign='center';eF.fillText('üöÄ AN√ÅLISE DE PROPULS√ÉO',w/2,50);eF.fillStyle=eG.azul;eF.font='bold 24px Arial';eF.fillText(`"${eC.nome}"`,w/2,90);eF.fillStyle=eG.subtitulo;eF.font='16px Arial';eF.fillText(`Teste realizado em: ${eH}`,w/2,120);eF.fillStyle=eG.verde;eF.font='bold 20px Arial';let eI=eD.impulso.impulsoTotal;eF.fillText(`üí• Impulso Total: ${eI.toFixed(2)} N‚ãÖs | Motor Classe ${_J.classe}`,w/2,155);eF.strokeStyle=eG.cinza;eF.lineWidth=2;eF.beginPath();eF.moveTo(w*0.1,180);eF.lineTo(w*0.9,180);eF.stroke();eD.kgf.length>0&&v(eF,eD,eG,w,h);eD.stats&&W(eF,eD,eG,w,h);X(eF,eD,eG,w,h);eF.fillStyle=eG.subtitulo;eF.font='12px Arial';eF.textAlign='left';eF.fillText('Sistema de An√°lise de Propuls√£o - GFIG',50,h-20);eF.textAlign='right';eF.fillText(`Gerado em: ${new Date().toLocaleString('pt-BR')}`,w-50,h-20);aC(eE,eC.nome+'_analise_propulsao')}function v(eJ,eK,eL,w,h){let eM=100,eN=220,eO=w-200,eP=400,_k=eK.tempos,_m=Math.min(...eQ,0),_n=_l-_m||0.001,_o=_n*0.1,_P=_m-_o,Q=_l+_o,R=Q-_P,T=eM+eO-180,U=eN+30;eJ.fillStyle=eL.titulo;eJ.font='bold 18px Arial';eJ.textAlign='center';eJ.fillText('üìà CURVA DE FOR√áA vs TEMPO (√Årea Sombreada = Impulso Total)',eM+eO/2,eN-20);eJ.fillStyle=eL.fundo2;eJ.fillRect(eM,eN,eO,eP);eJ.strokeStyle=eL.cinza;eJ.lineWidth=2;eJ.strokeRect(eM,eN,eO,eP);let eQ=eK.newtons;if(eQ.length===0)return;let _l=Math.max(...eQ);eJ.strokeStyle='#ecf0f1';eJ.lineWidth=1;eJ.setLineDash([3,3]);for(let i=0;i<=6;i++){const y=eN+(eP/6)*i,eR=Q-(R/6)*i;eJ.beginPath();eJ.moveTo(eM,y);eJ.lineTo(eM+eO,y);eJ.stroke();eJ.fillStyle=eL.cinza;eJ.font='12px Arial';eJ.textAlign='right';eJ.fillText(eR.toFixed(1)+'N',eM-10,y+4)}eJ.setLineDash([]);if(eQ.length>1){eJ.fillStyle='rgba(52, 152, 219, 0.3)';eJ.beginPath();let eS=eN+eP-((0-_P)/R)*eP;eJ.moveTo(eM,eS);for(let i=0;i<eQ.length;i++){const eT=Math.max(0,eQ[i]);eJ.lineTo(eM+(eO/(eQ.length-1))*i,eN+eP-((eT-_P)/R)*eP)}eJ.lineTo(eM+eO,eS);eJ.closePath();eJ.fill()}if(eQ.length>1){eJ.strokeStyle=eL.azul;eJ.lineWidth=3;eJ.beginPath();for(let i=0;i<eQ.length;i++){const x=eM+(eO/(eQ.length-1))*i,y=eN+eP-((eQ[i]-_P)/R)*eP;i===0?eJ.moveTo(x,y):eJ.lineTo(x,y)}eJ.stroke()}if(_P<0&&Q>0){let eU=eN+eP-((0-_P)/R)*eP;eJ.strokeStyle=eL.cinza;eJ.lineWidth=1;eJ.setLineDash([5,5]);eJ.beginPath();eJ.moveTo(eM,eU);eJ.lineTo(eM+eO,eU);eJ.stroke();eJ.setLineDash([])}eJ.fillStyle=eL.vermelho;let _s=eQ.indexOf(Math.max(...eQ));if(_s>=0){let x=eM+(eO/(eQ.length-1))*_s,y=eN+eP-((eQ[_s]-_P)/R)*eP;eJ.beginPath();eJ.arc(x,y,6,0,2*Math.PI);eJ.fill();eJ.fillStyle=eL.vermelho;eJ.font='bold 14px Arial';eJ.textAlign='center';eJ.fillText(`Fmax: ${eQ[_s].toFixed(1)}N`,x,y-20)}eJ.fillStyle=eL.titulo;eJ.font='bold 16px Arial';eJ.textAlign='center';eJ.save();eJ.translate(40,eN+eP/2);eJ.rotate(-Math.PI/2);eJ.fillText('For√ßa (N)',0,0);eJ.restore();eJ.fillText('Tempo (s)',eM+eO/2,eN+eP+50);eJ.fillStyle='rgba(52, 152, 219, 0.3)';eJ.fillRect(T,U,25,20);eJ.strokeStyle=eL.azul;eJ.lineWidth=2;eJ.strokeRect(T,U,25,20);eJ.fillStyle=eL.titulo;eJ.font='bold 14px Arial';eJ.textAlign='left';eJ.fillText('√Årea = Impulso',T+35,U+15);eJ.font='12px Arial';eJ.fillStyle=eL.verde;eJ.fillText(`${eK.impulso.impulsoTotal.toFixed(2)} N‚ãÖs`,T+35,U+30)}function W(eV,eW,eX,w,h){let eY=650,fA=eY+30,fB=w-200,fC=200,_L=[`M√©dia: ${(_K.media*9.81).toFixed(2)} N`,`M√°ximo: ${(_K.max*9.81).toFixed(2)} N`,`M√≠nimo: ${(_K.min*9.81).toFixed(2)} N`,`Desvio: ${(_K.desvio*9.81).toFixed(3)} N`,`CV: ${_K.cv.toFixed(1)}%`],_N=[`Impulso Total: ${_M.impulsoTotal.toFixed(3)} N‚ãÖs`,`Impulso Positivo: ${_M.impulsoPositivo.toFixed(3)} N‚ãÖs`,`Dura√ß√£o Queima: ${_M.duracaoQueima.toFixed(2)} s`,`Tempo Igni√ß√£o: ${_M.tempoIgnicao.toFixed(2)} s`,`Tempo Burnout: ${_M.tempoBurnout.toFixed(2)} s`],fD=eW.propulsao.classificacaoMotor;eV.fillStyle=eX.titulo;eV.font='bold 20px Arial';eV.textAlign='left';eV.fillText('üìä AN√ÅLISE ESTAT√çSTICA COMPLETA',100,eY);let eZ=100;eV.fillStyle=eX.fundo2;eV.fillRect(eZ,fA,fB,fC);eV.strokeStyle=eX.azul;eV.lineWidth=2;eV.strokeRect(eZ,fA,fB,fC);eV.fillStyle=eX.titulo;eV.font='bold 16px Arial';eV.fillText('üìà ESTAT√çSTICAS B√ÅSICAS',eZ+20,fA+30);eV.font='13px Arial';let _K=eW.stats;for(const[i,fE] of _L.entries())eV.fillText(fE,eZ+20,fA+55+i*20);eV.font='bold 16px Arial';eV.fillStyle=eX.verde;eV.fillText('üöÄ AN√ÅLISE DE IMPULSO',eZ+fB/2+20,fA+30);eV.font='13px Arial';eV.fillStyle=eX.titulo;let _M=eW.impulso;for(const[i,fF] of _N.entries())eV.fillText(fF,eZ+fB/2+20,fA+55+i*20);let _O=fA+160;eV.fillStyle=fD.cor;eV.fillRect(eZ+20,_O,40,30);eV.fillStyle='#ffffff';eV.font='bold 18px Arial';eV.textAlign='center';eV.fillText(fD.classe,eZ+40,_O+22);eV.fillStyle=eX.titulo;eV.font='bold 14px Arial';eV.textAlign='left';eV.fillText(`Motor Classe ${fD.classe}`,eZ+70,_O+15);eV.font='12px Arial';eV.fillText(fD.faixa,eZ+70,_O+28)}function X(fG,fH,fI,w,h){let fJ=880,fL=fJ+30,fM=w-200,fN=180,fP=fH.propulsao,fQ=[['Impulso Total:',`${fO.impulsoTotal.toFixed(3)} N‚ãÖs`,'For√ßa M√°xima:',`${fO.forcaMaxima.toFixed(2)} N`],['Impulso Positivo:',`${fO.impulsoPositivo.toFixed(3)} N‚ãÖs`,'For√ßa M√©dia:',`${fO.forcaMedia.toFixed(2)} N`],['Impulso Negativo:',`${fO.areaNegativa.toFixed(3)} N‚ãÖs`,'For√ßa M√©dia (>0):',`${fO.forcaMediaPositiva.toFixed(2)} N`],['Dura√ß√£o Total:',`${fH.duracao.toFixed(2)} s`,'Dura√ß√£o Queima:',`${fO.duracaoQueima.toFixed(2)} s`],['Tempo Igni√ß√£o:',`${fO.tempoIgnicao.toFixed(2)} s`,'Tempo Burnout:',`${fO.tempoBurnout.toFixed(2)} s`],['Classifica√ß√£o NAR:',fP.classificacaoMotor.classe,'Efici√™ncia Queima:',`${fP.eficienciaQueima.toFixed(1)}%`]];fG.fillStyle=fI.titulo;fG.font='bold 18px Arial';fG.textAlign='left';fG.fillText('üìã M√âTRICAS DE PROPULS√ÉO DETALHADAS',100,fJ);let fK=100;fG.fillStyle=fI.fundo2;fG.fillRect(fK,fL,fM,fN);fG.strokeStyle=fI.azul;fG.lineWidth=2;fG.strokeRect(fK,fL,fM,fN);fG.fillStyle=fI.azul;fG.font='bold 14px Arial';fG.fillText('PAR√ÇMETRO',fK+20,fL+25);fG.fillText('VALOR',fK+250,fL+25);fG.fillText('PAR√ÇMETRO',fK+450,fL+25);fG.fillText('VALOR',fK+680,fL+25);fG.strokeStyle=fI.cinza;fG.lineWidth=1;fG.beginPath();fG.moveTo(fK+20,fL+35);fG.lineTo(fK+fM-20,fL+35);fG.stroke();fG.font='13px Arial';fG.fillStyle=fI.titulo;let fO=fH.impulso;for(const[i,fR] of fQ.entries()){let y=fL+55+i*20;fG.fillStyle=fI.titulo;fG.fillText(fR[0],fK+20,y);fG.fillStyle=fI.azul;fG.fillText(fR[1],fK+250,y);fG.fillStyle=fI.titulo;fG.fillText(fR[2],fK+450,y);fG.fillStyle=fI.verde;fG.fillText(fR[3],fK+680,y)}}function Y(fS,fT){let fU=document.createElement('canvas'),fV=fU.getContext('2d'),w=1400,h=1000,fX=new Date(fS.timestamp).toLocaleString('pt-BR');fU.width=w;fU.height=h;let fW={fundo:'#ffffff',titulo:'#2c3e50',subtitulo:'#7f8c8d',azul:'#3498db',verde:'#27ae60',vermelho:'#e74c3c',cinza:'#95a5a6',fundo2:'#f8f9fa'};fV.fillStyle=fW.fundo;fV.fillRect(0,0,w,h);fV.fillStyle=fW.titulo;fV.font='bold 32px Arial';fV.textAlign='center';fV.fillText('üìä RELAT√ìRIO DA SESS√ÉO',w/2,50);fV.fillStyle=fW.azul;fV.font='bold 22px Arial';fV.fillText(`"${fS.nome}"`,w/2,85);fV.fillStyle=fW.subtitulo;fV.font='16px Arial';fV.fillText(`Gravada em: ${fX}`,w/2,115);fV.font='bold 14px Arial';fV.fillText(`${fT.pontos} pontos ‚Ä¢ ${fT.duracao.toFixed(1)}s de dura√ß√£o`,w/2,140);fV.strokeStyle=fW.cinza;fV.lineWidth=2;fV.beginPath();fV.moveTo(w*0.2,160);fV.lineTo(w*0.8,160);fV.stroke();fT.kgf.length>0&&z(fV,fT,fW,w,h);fT.stats&&aA(fV,fT.stats,fW,w,h);fV.fillStyle=fW.subtitulo;fV.font='12px Arial';fV.textAlign='left';fV.fillText('Sistema de Balan√ßa Digital',50,h-20);fV.textAlign='right';fV.fillText(`Gerado em: ${new Date().toLocaleString('pt-BR')}`,w-50,h-20);aC(fU,fS.nome)}function z(fY,fZ,gA,w,h){let gB=100,gC=200,gD=w-200,gE=350,gG=fZ.tempos,gI=Math.min(...gF),gJ=gH-gI||0.001,gK=gJ*0.1,gL=gI-gK,_q=gH+gK,_r=_q-gL;fY.fillStyle=gA.fundo2;fY.fillRect(gB,gC,gD,gE);fY.strokeStyle=gA.cinza;fY.lineWidth=2;fY.strokeRect(gB,gC,gD,gE);let gF=fZ.kgf;if(gF.length===0)return;let gH=Math.max(...gF);fY.strokeStyle='#ecf0f1';fY.lineWidth=1;fY.setLineDash([3,3]);for(let i=0;i<=5;i++){const y=gC+(gE/5)*i,gM=_q-(_r/5)*i;fY.beginPath();fY.moveTo(gB,y);fY.lineTo(gB+gD,y);fY.stroke();fY.fillStyle=gA.cinza;fY.font='11px Arial';fY.textAlign='right';fY.fillText(gM.toFixed(3),gB-10,y+3)}fY.setLineDash([]);if(gF.length>1){fY.strokeStyle=gA.azul;fY.lineWidth=3;fY.beginPath();for(let i=0;i<gF.length;i++){const x=gB+(gD/(gF.length-1))*i,y=gC+gE-((gF[i]-gL)/_r)*gE;i===0?fY.moveTo(x,y):fY.lineTo(x,y)}fY.stroke()}fY.fillStyle=gA.azul;for(let i=0;i<gF.length;i++){fY.beginPath();fY.arc(gB+(gD/Math.max(1,gF.length-1))*i,gC+gE-((gF[i]-gL)/_r)*gE,2,0,2*Math.PI);fY.fill()}fY.fillStyle=gA.titulo;fY.font='bold 14px Arial';fY.textAlign=fY.textAlign='center';fY.fillText('For√ßa (kgf)',50,gC+gE/2);fY.fillText('Tempo (s)',gB+gD/2,gC+gE+40);fY.fillStyle=gA.cinza;fY.font='10px Arial';let _S=Math.max(1,~~gF.length/8);for(let i=0;i<gF.length;i+=_S){fY.fillText(gG[i].toFixed(1),gB+(gD/Math.max(1,gF.length-1))*i,gC+gE+15)}}function aA(gN,gO,gP,w,h){let gQ=600,gS=gQ+20,gT=w-200,gU=120;gN.fillStyle=gP.titulo;gN.font='bold 18px Arial';gN.textAlign='left';gN.fillText('üìà ESTAT√çSTICAS',100,gQ);let gR=100;gN.fillStyle=gP.fundo2;gN.fillRect(gR,gS,gT,gU);gN.strokeStyle=gP.azul;gN.lineWidth=2;gN.strokeRect(gR,gS,gT,gU);gN.fillStyle=gP.titulo;gN.font='14px Arial';let gV=[[`M√©dia: ${gO.media.toFixed(4)} kgf`,`M√°ximo: ${gO.max.toFixed(4)} kgf`],[`M√≠nimo: ${gO.min.toFixed(4)} kgf`,`Mediana: ${gO.mediana.toFixed(4)} kgf`],[`Desvio Padr√£o: ${gO.desvio.toFixed(4)} kgf`,`Coef. Varia√ß√£o: ${gO.cv.toFixed(1)}%`],[`Amplitude: ${gO.amplitude.toFixed(4)} kgf`,`Qualidade: ${aB(gO.cv)}`]];for(const[i,gW] of gV.entries()){gN.fillText(gW[0],gR+20,gS+25+i*20);gN.fillText(gW[1],gR+gT/2+20,gS+25+i*20)}}function aB(cv){if(cv<5)return'Excelente';if(cv<15)return'Boa';if(cv<30)return'Regular';return'Ruidosa'}function aC(gX,gY){try{gX.toBlob(function(gZ){if(!gZ){showNotification('error','Erro ao criar arquivo');return}let hA=URL.createObjectURL(gZ),hB=document.createElement('a'),hC=gY.replace(/[^\d\sA-Za-z]/g,'').replace(/\s+/g,'_');hB.download=`relatorio_${hC}_${Date.now()}.png`;hB.href=hA;document.body.appendChild(hB);hB.click();document.body.removeChild(hB);setTimeout(()=>URL.revokeObjectURL(hA),1000);showNotification('success',`Relat√≥rio de "${gY}" exportado!`)},'image/png',1.0)}catch(e){console.error('Erro no download:',e);showNotification('error','Erro ao baixar: '+e.message)}}function aD(hD){try{let hE=JSON.parse(localStorage.getItem('balancaGravacoes'))||[],hF=hE.find(g=>g.id===hD),hH=hG.getContext('2d'),hJ=[`Total de pontos: ${hF.dadosTabela.length}`,`Primeira leitura: ${hF.dadosTabela[0]?.tempo_esp||'0'}s`,`√öltima leitura: ${hF.dadosTabela[hF.dadosTabela.length-1]?.tempo_esp||'0'}s`,`Maior for√ßa: ${Math.max(...hF.dadosTabela.map(d=>parseFloat(d.quilo_forca)||0)).toFixed(3)} kgf`,`Menor for√ßa: ${Math.min(...hF.dadosTabela.map(d=>parseFloat(d.quilo_forca)||0)).toFixed(3)} kgf`];if(!hF){showNotification('error','Sess√£o n√£o encontrada');return}let hG=document.createElement('canvas');hG.width=800;hG.height=600;hH.fillStyle='#ffffff';hH.fillRect(0,0,800,600);hH.fillStyle='#2c3e50';hH.font='bold 24px Arial';hH.textAlign='center';hH.fillText('Relat√≥rio da Sess√£o',400,50);hH.font='bold 18px Arial';hH.fillStyle='#3498db';hH.fillText(hF.nome,400,80);hH.font='14px Arial';hH.fillStyle='#7f8c8d';let hI=new Date(hF.timestamp).toLocaleString('pt-BR');hH.fillText(`Gravada em: ${hI}`,400,110);hH.font='16px Arial';hH.fillStyle='#2c3e50';hH.textAlign='left';for(const[i,hK] of hJ.entries())hH.fillText(hK,50,180+i*30);aC(hG,hF.nome+'_resumo')}catch(e){console.error('Erro:',e);showNotification('error','Erro: '+e.message)}}async function aE(){let hL=document.getElementById('lista-gravacoes'),hN=[],hP=[];if(!hL)return;hL.innerHTML='';let hM=JSON.parse(localStorage.getItem('balancaGravacoes'))||[];isMysqlConnected&&(showNotification('info','Buscando grava√ß√µes do MySQL...'),hN=await fetchSessionsFromMysqlViaWorker());let hO=new Map(hM.map(s=>[s.id,s]));let hQ=new Set;for(const hR of hN){hP.push(hR);hQ.add(hR.id)}for(const hS of hM)!hQ.has(hS.id)&&hP.push(hS);hP.sort((a,b)=>b.id-a.id);aG(hP);showNotification('info',`Carregadas ${hP.length} grava√ß√µes (local e MySQL).`)}function aF(hT,hU){let hV=new Date(hT.timestamp).toLocaleString('pt-BR'),hW=hU.propulsao.classificacaoMotor.classe,hX=hU.impulso,hY=document.createElement('div'),iA='';hY.className='card-gravacao';hY.style.cssText=`
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--cor-fundo-card);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 10px;
      border-left: 5px solid ${hU.propulsao.classificacaoMotor.cor||'var(--cor-primaria)'};
    `;let hZ='';hZ+='<span title="Salvo Localmente" style="margin-left: 5px; color: #3498db;">&#x1F4C7;</span>';hT.savedToMysql&&(hZ+='<span title="Salvo no MySQL" style="margin-left: 5px; color: #27ae60;">&#x1F4BE;</span>');!hT.savedToMysql&&(iA=`<button class="btn btn-sucesso btn-small" onclick="persistToMysql(${hT.id})">üíæ Salvar no MySQL</button>`);hY.innerHTML=`
      <div>
          <p style="font-weight: 600; margin-bottom: 5px;">${hT.nome} <span style="font-size: 0.75rem; background: ${hU.propulsao.classificacaoMotor.cor||'var(--cor-primaria)'}; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">CLASSE ${hW}</span></p>
          <p style="font-size: 0.875rem; color: var(--cor-texto-secundario);">
              ${hV} ‚Ä¢ Impulso Total: ${hX.impulsoTotal.toFixed(2)} N‚ãÖs
              ${hZ}
          </p>
      </div>
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button onclick="visualizarSessao(${hT.id})" title="Carregar para An√°lise/Gr√°fico" class="btn btn-info">üëÅÔ∏è Ver</button>
          <button onclick="exportarImagemSessao(${hT.id})" title="Exportar Gr√°fico em PNG" class="btn btn-primario">üñºÔ∏è PNG</button>
          <button onclick="exportarPDFViaPrint(${hT.id})" title="Exportar Relat√≥rio PDF" class="btn btn-secundario">üìë PDF</button>
          <button onclick="exportarCSV(${hT.id})" title="Exportar Dados em CSV" class="btn btn-sucesso">üìÑ CSV</button>
          <button onclick="exportarMotorENG(${hT.id})" title="Exportar Curva de Empuxo para OpenRocket/RASAero" class="btn btn-aviso">üöÄ ENG</button>
          ${iA}
          <button onclick="deletarGravacao(${hT.id})" title="Deletar Sess√£o" class="btn btn-perigo">üóëÔ∏è Del</button>
      </div>
    `;return hY}function aG(iB){let iC=document.getElementById('lista-gravacoes');if(!iC)return;iC.innerHTML='';if(iB.length===0){iC.innerHTML='<p style="text-align: center; color: var(--cor-texto-secundario);">Nenhuma grava√ß√£o salva localmente ou no MySQL.</p>';return}for(const iD of iB){iC.appendChild(aF(iD,q(iD.dadosTabela)))}}function aH(iE){try{let iF=JSON.parse(localStorage.getItem('balancaGravacoes'))||[],iG=iF.find(g=>g.id===iE);if(!iG){showNotification('error','Sess√£o n√£o encontrada');return}clearChart();let iH=[];rawDataN=[];for(const iI of iG.dadosTabela){let iJ=parseFloat(iI.tempo_esp)||0,iK=parseFloat(iI.newtons)||0;iH.push([iJ,convertForce(iK,displayUnit)]);rawDataN.push([iJ,iK])}chart.updateSeries([{data:iH}]);rawDataN.length>0&&(maxForceInN=Math.max(...rawDataN.map(p=>p[1])),minForceInN=Math.min(...rawDataN.map(p=>p[1])));abrirAba(document.getElementById('padrao'),'abaGrafico');setChartMode('pausado');showNotification('success',`Sess√£o "${iG.nome}" carregada! Gr√°fico pausado.`)}catch(e){console.error('Erro ao visualizar:',e);showNotification('error','Erro ao carregar sess√£o')}}function aI(){if(chartData.series[0].length<2){showNotification('info','Dados insuficientes para calcular impulso');return}let iL=_(chartData.labels.map(iO=>parseFloat(iO)),rawDataN,!1),iM=B(iL);showNotification('info',`
üöÄ IMPULSO EM TEMPO REAL:

üìä Impulso Atual: ${iL.impulsoTotal.toFixed(3)} N‚ãÖs
‚ö° For√ßa M√°xima: ${iL.forcaMaxima.toFixed(2)} N
üìà For√ßa M√©dia: ${iL.forcaMedia.toFixed(2)} N
‚è±Ô∏è Dura√ß√£o: ${iL.duracaoQueima.toFixed(1)} s
üè∑Ô∏è Classifica√ß√£o: Motor ${iM.classificacaoMotor.classe}
  `,8000)}function aJ(){let iP=_([0,0.2,0.4,0.6,0.8,1.0,1.2,1.4,1.6,1.8,2.0],[0,5,12,15,14,12,8,5,2,1,0],!1),iQ=B(iP);console.log('=== TESTE DO C√ÅLCULO DE IMPULSO ===');console.log('Impulso Total:',iP.impulsoTotal.toFixed(3),'N‚ãÖs');console.log('For√ßa M√°xima:',iP.forcaMaxima.toFixed(1),'N');console.log('Dura√ß√£o:',iP.duracaoQueima.toFixed(1),'s');console.log('Classifica√ß√£o:',iQ.classificacaoMotor.classe);iP.impulsoTotal>=10&&iP.impulsoTotal<=20?console.log('‚úÖ Teste passou - Impulso na faixa esperada'):console.log('‚ùå Teste falhou - Impulso fora da faixa')}function aK(){let iR=document.getElementById('importar-arquivo-motor'),iS=document.getElementById('nome-importacao'),iT=iR.files[0],iU=iS.value.trim();if(!iT){showNotification('error','Selecione um arquivo de teste est√°tico (.txt ou .log).');return}if(!iU){showNotification('error','D√™ um nome para a sess√£o importada.');iS.focus();return}showNotification('info',`Lendo arquivo "${iT.name}"...`,3000);let iV=new FileReader;iV.onload=e=>{let iW=e.target.result;try{aM(iU,aL(iW));iR.value=iS.value=''}catch(iX){showNotification('error','Erro ao processar arquivo: '+iX.message);console.error('Erro ao processar dados externos:',iX)}};iV.onerror=()=>showNotification('error','Erro ao ler o arquivo.');iV.readAsText(iT)}function aL(iY){let iZ=iY.split('\n'),jA=[],jB=9.80665,jC=/^\s*(\d+\.\d+e?[+-]?\d*)\s+(\d+\.\d+e?[+-]?\d*)\s*$/i,jD=!1;for(let i=0;i<iZ.length;i++){const jE=iZ[i].trim();if(jE.startsWith('#')||jE.startsWith('//')||jE.length===0)continue;if(jE.toLowerCase().includes('t [s]')&&jE.toLowerCase().includes('f [n]')){continue}const jF=jE.match(jC);if(jF){let jG=parseFloat(jF[1]),jH=parseFloat(jF[2]);if(!isNaN(jG)&&!isNaN(jH)){jD=!0;let jI=jB>0?jH/jB:0,jJ=101.9716;jA.push({timestamp:new Date().toISOString(),tempo_esp:jG.toFixed(6),newtons:jH.toFixed(6),grama_forca:(jH*jJ).toFixed(6),quilo_forca:(jH*(jJ/1000)).toFixed(6)})}}else if(jD)break}if(jA.length===0)throw Error('N√£o foi poss√≠vel extrair dados v√°lidos de Tempo [s] e For√ßa [N] do arquivo.');return jA}function aM(jK,jL){let jM={id:Date.now(),nome:jK,timestamp:new Date().toISOString(),dadosTabela:jL};try{let jN=JSON.parse(localStorage.getItem('balancaGravacoes'))||[];jN.push(jM);localStorage.setItem('balancaGravacoes',JSON.stringify(jN));showNotification('success',`Sess√£o "${jK}" importada e salva com sucesso!`);aE()}catch(e){showNotification('error','Erro ao salvar. O Local Storage pode estar cheio.');console.error('Erro ao salvar no LocalStorage:',e)}}function aN(jO){try{let jP=JSON.parse(localStorage.getItem('balancaGravacoes'))||[],jQ=jP.find(g=>g.id===jO),jS=jR.name||document.getElementById('eng-name').value.trim()||jQ.nome.replace(/\W/g,'_'),jT=jR.diameter||parseFloat(document.getElementById('eng-diameter').value)||45,jU=jR.length||parseFloat(document.getElementById('eng-length').value)||200,jV=jR.delay||parseFloat(document.getElementById('eng-delay').value)||0,jW=jR.propweight||parseFloat(document.getElementById('eng-propweight').value)||0.1,jX=jR.totalweight||parseFloat(document.getElementById('eng-totalweight').value)||0.25,jY=jR.manufacturer||document.getElementById('eng-manufacturer').value.trim()||'GFIG-IFC',kA='',kB=jQ.dadosTabela.length-1,kD=jZ+kA,kE=document.createElement('a');if(!jQ||!jQ.dadosTabela||jQ.dadosTabela.length===0){showNotification('error','Sess√£o n√£o encontrada ou sem dados');return}let jR=jQ.metadadosMotor||{};if(!jS||isNaN(jT)||isNaN(jU)||isNaN(jW)||isNaN(jX)){showNotification('error','Os Metadados do Motor est√£o incompletos. Por favor, preencha os campos na aba Grava√ß√µes e salve a sess√£o novamente ou edite o motor.');return}let jZ=`
; Arquivo de Curva de Empuxo (.eng) gerado pelo GFIG (Balan√ßa Wi-Fi)
; Sess√£o de Teste: ${jQ.nome}
; Data de Grava√ß√£o: ${new Date(jQ.timestamp).toLocaleString('pt-BR')}
;
; Par√¢metros do Motor (Requeridos pelo openRocket):
; name diameter length delay propweight totalweight manufacturer
${jS} ${jT.toFixed(1)} ${jU.toFixed(0)} ${jV.toFixed(1)} ${jW.toFixed(5)} ${jX.toFixed(5)} ${jY}
;
; Dados no formato: Tempo [s] Empuxo [N]
`;for(let i=0;i<kB;i++){const kF=jQ.dadosTabela[i],kG=parseFloat(kF.tempo_esp)||0;kA+=` ${kG}	${Math.max(0,parseFloat(kF.newtons)||0)}
`}let kC=jQ.dadosTabela[kB];kC&&(kA+=` ${parseFloat(kC.tempo_esp).toFixed(3)}\t0.000\n`);kE.href=URL.createObjectURL(new Blob([kD], {type:'text/plain;charset=utf-8;'}));kE.setAttribute('download',`${jS}.eng`);document.body.appendChild(kE);kE.click();document.body.removeChild(kE);showNotification('success',`Arquivo ${jS}.eng exportado com sucesso!`)}catch(e){console.error('Erro ao exportar .ENG:',e);showNotification('error','Erro ao exportar motor .ENG: '+e.message)}}
