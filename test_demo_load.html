<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teste de Carregamento AutomÃ¡tico - Demo JSON</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #2c3e50; }
    .status {
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover { background: #0056b3; }
    button.danger { background: #dc3545; }
    button.danger:hover { background: #c82333; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª Teste de Carregamento AutomÃ¡tico</h1>
    <p>Este teste verifica se os arquivos JSON de demonstraÃ§Ã£o sÃ£o carregados automaticamente quando:</p>
    <ul>
      <li>A aplicaÃ§Ã£o detecta modo GitHub Pages (simulado aqui)</li>
      <li>NÃ£o hÃ¡ sessÃµes gravadas no localStorage</li>
    </ul>

    <div id="github-status" class="status info">
      ğŸ” Verificando modo GitHub Pages...
    </div>

    <div id="localstorage-status" class="status info">
      ğŸ“¦ Verificando localStorage...
    </div>

    <div id="demo-load-status" class="status info">
      â³ Aguardando teste...
    </div>

    <div style="margin: 20px 0;">
      <button onclick="runTest()">â–¶ï¸ Executar Teste</button>
      <button onclick="clearLocalStorage()" class="danger">ğŸ—‘ï¸ Limpar localStorage</button>
      <button onclick="showLocalStorage()">ğŸ“‹ Mostrar localStorage</button>
    </div>

    <h3>ğŸ“ Log de Console:</h3>
    <div id="console-log" class="log"></div>
  </div>

  <script>
    // Intercepta console.log
    const logDiv = document.getElementById('console-log');
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;

    function addToLog(type, ...args) {
      const timestamp = new Date().toLocaleTimeString();
      const message = args.map(arg =>
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
      ).join(' ');
      logDiv.innerHTML += `[${timestamp}] [${type}] ${message}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    console.log = function(...args) {
      originalLog.apply(console, args);
      addToLog('LOG', ...args);
    };

    console.error = function(...args) {
      originalError.apply(console, args);
      addToLog('ERROR', ...args);
    };

    console.warn = function(...args) {
      originalWarn.apply(console, args);
      addToLog('WARN', ...args);
    };

    // Simula a funÃ§Ã£o isGitHubPages retornando true
    function isGitHubPages() {
      return true; // ForÃ§ado para teste
    }

    // Copia a funÃ§Ã£o do script.js
    async function loadDemoJsonSessions() {
      const demoFiles = ['F50.json', 'G60.json', 'Teste_Automatizado_091512.json'];
      const loadedSessions = [];

      console.log('[loadDemoJsonSessions] Carregando arquivos JSON de demonstraÃ§Ã£o...');

      for (const filename of demoFiles) {
        try {
          const response = await fetch(`json/${filename}`);
          if (!response.ok) {
            console.warn(`[loadDemoJsonSessions] NÃ£o foi possÃ­vel carregar ${filename}: ${response.statusText}`);
            continue;
          }

          const sessionData = await response.json();

          if (sessionData && sessionData.dadosTabela) {
            loadedSessions.push(sessionData);
            console.log(`[loadDemoJsonSessions] âœ“ Carregado: ${filename} (${sessionData.nome || 'sem nome'})`);
          } else {
            console.warn(`[loadDemoJsonSessions] Arquivo ${filename} nÃ£o tem estrutura vÃ¡lida`);
          }
        } catch (error) {
          console.error(`[loadDemoJsonSessions] Erro ao carregar ${filename}:`, error);
        }
      }

      if (loadedSessions.length > 0) {
        try {
          localStorage.setItem('balancaGravacoes', JSON.stringify(loadedSessions));
          console.log(`[loadDemoJsonSessions] ${loadedSessions.length} sessÃµes de demonstraÃ§Ã£o salvas no localStorage`);
          return loadedSessions;
        } catch (error) {
          console.error('[loadDemoJsonSessions] Erro ao salvar no localStorage:', error);
        }
      } else {
        console.warn('[loadDemoJsonSessions] Nenhuma sessÃ£o de demonstraÃ§Ã£o foi carregada');
      }

      return loadedSessions;
    }

    async function runTest() {
      logDiv.innerHTML = '';
      console.log('=== INICIANDO TESTE ===');

      // 1. Verifica modo GitHub Pages
      const isGithub = isGitHubPages();
      const githubStatus = document.getElementById('github-status');
      if (isGithub) {
        githubStatus.className = 'status success';
        githubStatus.innerHTML = 'âœ… Modo GitHub Pages: ATIVO (simulado)';
        console.log('âœ… Modo GitHub Pages detectado');
      } else {
        githubStatus.className = 'status error';
        githubStatus.innerHTML = 'âŒ Modo GitHub Pages: INATIVO';
        console.log('âŒ Modo GitHub Pages nÃ£o detectado');
      }

      // 2. Verifica localStorage
      let sessions = [];
      try {
        sessions = JSON.parse(localStorage.getItem('balancaGravacoes')) || [];
      } catch (e) {
        console.error('Erro ao ler localStorage:', e);
      }

      const localStorageStatus = document.getElementById('localstorage-status');
      if (sessions.length === 0) {
        localStorageStatus.className = 'status info';
        localStorageStatus.innerHTML = `ğŸ“¦ localStorage: VAZIO (${sessions.length} sessÃµes)`;
        console.log('ğŸ“¦ localStorage vazio - condiÃ§Ã£o atendida para carregamento automÃ¡tico');
      } else {
        localStorageStatus.className = 'status success';
        localStorageStatus.innerHTML = `ğŸ“¦ localStorage: ${sessions.length} sessÃ£o(Ãµes) encontrada(s)`;
        console.log(`ğŸ“¦ localStorage contÃ©m ${sessions.length} sessÃ£o(Ãµes)`);
      }

      // 3. Testa carregamento
      const demoLoadStatus = document.getElementById('demo-load-status');

      if (isGithub && sessions.length === 0) {
        demoLoadStatus.className = 'status info';
        demoLoadStatus.innerHTML = 'â³ CondiÃ§Ãµes atendidas! Carregando arquivos JSON...';
        console.log('ğŸš€ Iniciando carregamento automÃ¡tico dos arquivos de demonstraÃ§Ã£o...');

        try {
          const loaded = await loadDemoJsonSessions();

          if (loaded && loaded.length > 0) {
            demoLoadStatus.className = 'status success';
            demoLoadStatus.innerHTML = `âœ… SUCESSO! ${loaded.length} arquivo(s) JSON carregado(s) e salvos no localStorage`;
            console.log(`âœ… Teste concluÃ­do com sucesso! ${loaded.length} arquivo(s) carregado(s)`);
            console.log('SessÃµes carregadas:', loaded.map(s => s.nome).join(', '));

            // Atualiza status do localStorage
            localStorageStatus.className = 'status success';
            localStorageStatus.innerHTML = `ğŸ“¦ localStorage: ${loaded.length} sessÃ£o(Ãµes) - ATUALIZADO`;
          } else {
            demoLoadStatus.className = 'status error';
            demoLoadStatus.innerHTML = 'âŒ ERRO: Nenhum arquivo foi carregado';
            console.error('âŒ Falha: Nenhum arquivo foi carregado');
          }
        } catch (error) {
          demoLoadStatus.className = 'status error';
          demoLoadStatus.innerHTML = `âŒ ERRO: ${error.message}`;
          console.error('âŒ Erro durante o carregamento:', error);
        }
      } else {
        demoLoadStatus.className = 'status info';
        demoLoadStatus.innerHTML = 'âš ï¸ CondiÃ§Ãµes nÃ£o atendidas - carregamento nÃ£o executado';
        if (!isGithub) {
          console.warn('âš ï¸ Modo GitHub Pages nÃ£o estÃ¡ ativo');
        }
        if (sessions.length > 0) {
          console.warn('âš ï¸ localStorage jÃ¡ contÃ©m sessÃµes');
        }
      }

      console.log('=== TESTE FINALIZADO ===');
    }

    function clearLocalStorage() {
      localStorage.removeItem('balancaGravacoes');
      console.log('ğŸ—‘ï¸ localStorage limpo');
      document.getElementById('localstorage-status').className = 'status info';
      document.getElementById('localstorage-status').innerHTML = 'ğŸ“¦ localStorage: VAZIO (0 sessÃµes)';
    }

    function showLocalStorage() {
      const sessions = JSON.parse(localStorage.getItem('balancaGravacoes')) || [];
      console.log('ğŸ“‹ ConteÃºdo do localStorage:');
      console.log(`Total de sessÃµes: ${sessions.length}`);
      if (sessions.length > 0) {
        sessions.forEach((session, index) => {
          console.log(`\nSessÃ£o ${index + 1}:`);
          console.log(`  ID: ${session.id}`);
          console.log(`  Nome: ${session.nome}`);
          console.log(`  Data inÃ­cio: ${session.data_inicio}`);
          console.log(`  Leituras: ${session.dadosTabela ? session.dadosTabela.length : 0}`);
        });
      }
    }

    // Executa verificaÃ§Ãµes iniciais ao carregar
    window.addEventListener('DOMContentLoaded', () => {
      console.log('ğŸ”§ PÃ¡gina de teste carregada');
      console.log('ğŸ‘‰ Clique em "Executar Teste" para iniciar');
    });
  </script>
</body>
</html>
