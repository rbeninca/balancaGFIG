const{isArray:A}=Array;console.log('üöÄ dataWorker.js carregado com sucesso!');let c,d=[],_=9.80665,f=0.2,g=0,h=!1,B=-Infinity,j='',k=!1,l='',m=null,N=0,o=0,p=0,q=Date.now(),r=0,b=a=>a==void 0;(()=>{if(k){console.log('[Worker] üö´ N√£o tentando conex√£o inicial em modo GitHub Pages.');return}console.log('[Worker] üöÄ Tentando conex√£o r√°pida com URL padr√£o...');let C=location.hostname;(location.port==='5500'||C==='localhost'||C==='127.0.0.1')&&(C='localhost');j=`ws://${C}:81`;console.log(`[Worker] URL padr√£o definida: ${j}`);setTimeout(()=>s(),10)})();function s(){if(k){console.log('[Worker] üö´ connectWebSocket ignorado em modo GitHub Pages.');return}if(c&&c.readyState!==WebSocket.CLOSED){console.log(`[Worker] Socket j√° existe. Estado: ${c.readyState}`);return}let _a=j;if(!_a){console.log('[Worker] wsURL is empty. Constructing from location.');let D=location.hostname,_b=81;(location.port==='5500'||D==='localhost'||D==='127.0.0.1')&&(D='localhost');_a=`ws://${D}:${_b}`;console.log(`[Worker] Constructed default WebSocket URL: ${_a}`)}else{let _A=_a.trim(),_d=_B>_c;(!_A.startsWith('ws://')&&!_A.startsWith('wss://'))&&(_A=`ws://${_A}`);let _B=_A.lastIndexOf(':');let _c=_A.lastIndexOf(']');!_d&&(_A+=':81');_a=_A;console.log(`[Worker] Using provided WebSocket URL: ${_a}`)}console.log(`[Worker] üîÑ Attempting to connect WebSocket to: ${_a}`);self.postMessage({type:'debug',message:`Attempting WS connect to: ${_a}`});try{c=new WebSocket(_a)}catch(e){console.error('[Worker] ‚ùå Erro ao criar WebSocket:',e);self.postMessage({type:'status',status:'error',message:'URL de WebSocket inv√°lida: '+e.message});return}c.onopen=()=>{console.log(`[Worker] ‚úÖ WebSocket CONECTADO! Estado: ${c.readyState}, URL: ${c.url}`);self.postMessage({type:'status',status:'connected',message:'Conectado ao Gateway Serial (Host)'});self.postMessage({type:'debug',message:`WebSocket connected to: ${c.url}`});try{let E=JSON.stringify({cmd:'get_config'});setTimeout(()=>{(c&&c.readyState===WebSocket.OPEN)&&(c.send(E),console.log('[Worker] üîé get_config enviado automaticamente ap√≥s conex√£o'))},100)}catch(e){console.warn('[Worker] N√£o foi poss√≠vel enviar get_config autom√°tico:',e.message)}};c.onclose=aA=>{console.log(`[Worker] ‚ö†Ô∏è WebSocket FECHADO. Code: ${aA.code}, Reason: ${aA.reason}, Clean: ${aA.wasClean}. Estado: ${c?c.readyState:'null'}, URL: ${c?c.url:'null'}`);self.postMessage({type:'status',status:'disconnected',message:`Desconectado (${aA.code}). Tentando reconectar...`});c=null};c.onerror=aB=>{console.error('[Worker] ‚ùå Erro WebSocket:',aB);c&&console.error(`[Worker] Estado do Socket: ${c.readyState}, URL: ${c.url}`);self.postMessage({type:'status',status:'error',message:'Erro na conex√£o WebSocket com o Host.'});c=null};c.onmessage=aC=>{l+=aC.data;let aD=0;while(aD<l.length){let aE=l[aD],_C=!1,_D=!1,_e=-1;if(aE!=='{'&&aE!=='['){aD++;continue}let aF=0;for(let i=aD;i<l.length;i++){const aG=l[i];(aG==='"'&&!_D)&&(_C=!_C);aG==='\\'&&_C?_D=!_D:_D=!1;if(!_C)if(aG==='{'||aG==='[')aF++;else if(aG==='}'||aG===']'){aF--;if(aF===0){_e=i;break}}}if(_e!==-1){let aH=l.substring(aD,_e+1),aI=!1;try{t(JSON.parse(aH));aI=!0}catch(e1){try{console.warn('[Worker] ‚ö†Ô∏è JSON corrigido (NaN/Infinity e/ou v√≠rgulas finais)');t(JSON.parse(aH.replace(/:(\s*)(NaN|Infinity|-Infinity)(\s*)([,}\]])/g,': null$3$4').replace(/,(\s*[}\]])/g,'$1')));aI=!0}catch(aJ){console.error('[Worker] ‚ùå JSON inv√°lido (ap√≥s saneamento):',aJ.message);console.error('[Worker] String problem√°tica (in√≠cio):',aH.substring(0,200));aD=_e+1;continue}}aI&&(aD=_e+1)}else break}l=l.substring(aD);l.length>10000&&(console.warn('[Worker] ‚ö†Ô∏è Buffer muito grande, limpando...'),l='')}}function t(aK){!b(aK.mysql_connected)&&self.postMessage({type:'mysql_status_update',payload:aK.mysql_connected});if(A(aK))for(const aL of aK)u(aL);else if(typeof aK==='object'&&aK.type)switch(aK.type) {case 'data':u(aK);break;case 'config':let aM={...aK};let aN=(v,aO)=>{let n=parseFloat(v);return Number.isFinite(n)?n:aO};aM.conversionFactor=aN(aM.conversionFactor,1);aM.gravity=aN(aM.gravity,9.80665);aM.leiturasEstaveis=aN(aM.leiturasEstaveis,10);aM.toleranciaEstabilidade=aN(aM.toleranciaEstabilidade,500);aM.numAmostrasMedia=aN(aM.numAmostrasMedia,10);aM.timeoutCalibracao=aN(aM.timeoutCalibracao,5000);aM.capacidadeMaximaGramas=aN(aM.capacidadeMaximaGramas,5000);aM.percentualAcuracia=aN(aM.percentualAcuracia,0.05);console.log('[Worker] Valores sanitizados:');console.log('  capacidadeMaximaGramas:',aK.capacidadeMaximaGramas,'‚Üí',aM.capacidadeMaximaGramas);console.log('  percentualAcuracia:',aK.percentualAcuracia,'‚Üí',aM.percentualAcuracia);console.log('  toleranciaEstabilidade:',aK.toleranciaEstabilidade,'‚Üí',aM.toleranciaEstabilidade);console.log('  timeoutCalibracao:',aK.timeoutCalibracao,'‚Üí',aM.timeoutCalibracao);console.log('  Erro Absoluto (Zona Morta):',(aM.capacidadeMaximaGramas*aM.percentualAcuracia).toFixed(2),'g');aM.gravity&&(_=aM.gravity);console.log('[Worker] CONFIGURA√á√ÉO RECEBIDA:',aM);self.postMessage({type:'config',payload:aM});break;case 'status':self.postMessage({type:'status',status:aK.type,message:aK.message});break;case 'mysql_save_success':self.postMessage({type:'mysql_save_success',payload:{message:aK.message,sessionId:aK.sessionId}});break;case 'mysql_save_error':self.postMessage({type:'mysql_save_error',payload:{message:aK.message,sessionId:aK.sessionId}});break}}function u(aP){if(aP.type!=='data'){console.log(`[Worker] ‚ö†Ô∏è Ignorando ponto que n√£o √© 'data'. Tipo: ${aP.type}`);return}let aQ=aP.forca,aS=_>0?aQ/_:0,F=(_E-q)/1000;aQ>B&&(B=aQ);let aR=V(aQ);d.push({tempo:aP.tempo,forca:aQ,ema:aR,maxForce:B,massaKg:aS});p++;let _E=Date.now();F>=1.0&&(r=p/F,p=0,q=_E);if(m!==null){let aT=aP.tempo-m;if(aT>0){let aU=1/aT;o=(o*N+aU)/(N+1);N++}}m=aP.tempo}function V(aV){!h?(g=aV,h=!0):(g=(f*aV)+((1-f)*g));return g}self.onmessage=e=>{const{type:aW,payload:aX}=e.data;switch(aW) {case 'set_github_pages_mode':k=aX.isGitHubPages;console.log(`[Worker] GitHub Pages Mode set to: ${k}`);if(k){c&&(c.close(),c=null);self.postMessage({type:'status',status:'disconnected',message:'WebSocket desabilitado no GitHub Pages.'})}break;case 'set_ws_url':if(k){console.warn('[Worker] Ignorando set_ws_url em modo GitHub Pages.');j=null;return}if(aX?.url){j=aX.url;console.log(`[Worker] URL do WebSocket definida para: ${j}`);(c&&c.readyState===WebSocket.CLOSED)&&s()}else{j=null;c&&(c.close(),c=null);self.postMessage({type:'status',status:'disconnected',message:'WebSocket URL inv√°lida ou desabilitada.'})}break;case 'solicitarDados':d.length>0?(self.postMessage({type:'dadosDisponiveis',payload:d}),d=[]):();break;case 'getRPS':self.postMessage({type:'rps',payload:r.toFixed(1)});break;case 'sendCommand':if(!c||c.readyState!==WebSocket.OPEN){console.error('[Worker] ‚ùå WebSocket n√£o est√° conectado! Estado:',c?c.readyState:'null');self.postMessage({type:'status',status:'error',message:'Erro: WebSocket n√£o conectado. N√£o foi poss√≠vel enviar o comando.'});return}console.log(`[Worker] üì§ Comando recebido da UI:`,aX);let aY={};if(aX.cmd==='save_session_to_mysql'){aY.cmd='save_session_to_mysql';aY.payload=aX.sessionData;console.log('[Worker] ‚úÖ Comando SAVE_SESSION_TO_MYSQL identificado')}else if(aX.cmd==='t'){aY.cmd='t';console.log('[Worker] ‚úÖ Comando de TARA identificado')}else if(aX.cmd==='get_config'){aY.cmd='get_config';console.log('[Worker] ‚úÖ Comando GET_CONFIG identificado')}else if(aX.cmd==='c'){let aZ=parseFloat(aX.value);if(isNaN(aZ)||aZ<=0){console.error('[Worker] ‚ùå Comando \'c\' inv√°lido. Massa n√£o num√©rica ou <= 0.');self.postMessage({type:'status',status:'error',message:'Massa de calibra√ß√£o inv√°lida.'});return}aY.cmd='c';aY.massa_g=aZ;console.log(`[Worker] ‚úÖ Comando de CALIBRA√á√ÉO identificado com massa: ${aZ}g`)}else if(aX.cmd==='set'){let bA=aX.value.param,bB=aX.value.value;if(!bA||isNaN(bB)){console.error(`[Worker] ‚ùå Comando 'set' inv√°lido. Par√¢metro ou valor inv√°lido.`);self.postMessage({type:'status',status:'error',message:'Formato de comando inv√°lido para set_param.'});return}aY.cmd='set';aY.param=bA;aY.value=bB;console.log(`[Worker] ‚úÖ Comando SET_PARAM montado:`,aY)}else{console.warn(`[Worker] ‚ö†Ô∏è Comando desconhecido da UI:`,aX);self.postMessage({type:'status',status:'error',message:`Comando desconhecido: ${aX.cmd}`});return}if(aY.cmd){let bC=JSON.stringify(aY);console.log(`[Worker] üöÄ Enviando para WebSocket: ${bC}`);try{c.send(bC);console.log(`[Worker] ‚úÖ Comando enviado com sucesso`);self.postMessage({type:'status',status:'info',message:`Comando "${aY.cmd}" enviado ao ESP32`})}catch(bD){console.error(`[Worker] ‚ùå Erro ao enviar comando:`,bD);self.postMessage({type:'status',status:'error',message:`Erro ao enviar comando: ${bD.message}`})}}else console.error(`[Worker] ‚ùå commandToSend.cmd n√£o foi definido!`);break}};setInterval(()=>{if(k)return;(c==null||c.readyState===WebSocket.CLOSED)&&(console.log('[Worker] üîÑ Tentando reconectar ao WebSocket do Host...'),s())},1000);
