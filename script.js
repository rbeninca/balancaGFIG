let A=a=>typeof a==='function';const{isArray:_}=Array;let c=a=>typeof a==='string';let E=0,F=5,G={},h,V,w,x=100,y='deslizante',z=!1,aA='kgf',aB=-Infinity,aC=Infinity,aD=0,aE=0,aF=[],aG=!1,aH=!1,aI=[],aJ=null,aK=null,aL=null,aM=null,aN=100,aO=null,aU=!1,aV=0,aX=!1,aY=[],aZ=50,bA=0,bB=0,bC=2.0,bD=5000.0,bE=0.05,bF=!0,bG=!0,bH=!1,bI=null,bJ=!0,bK=0,cV=null,cW=null,cX=null,dJ=!1,dK=0,eR='points',eS=6,eT=!0,B=a=>a==void 0;function I(){let C=document.getElementById('wizard-modal'),_c=()=>{cG('get_config');h=setTimeout(()=>{_b>0?(_b--,_c()):(document.getElementById('wizard-loading').style.display='none',document.getElementById('wizard-error').style.display='block')},1000)};C.style.display='block';E=0;G={};document.getElementById('wizard-loading').style.display='block';document.getElementById('wizard-error').style.display='none';L(0);if(bL()){console.warn('[Wizard] GitHub Pages detectado - pulando busca de configuraÃ§Ã£o');document.getElementById('wizard-loading').style.display='none';return}let _b=10;_c()}function j(){let _a=document.getElementById('wizard-modal');_a.style.display='none';clearTimeout(h)}function k(D){let _B=E+D;if(D>0){if(!n(E))return;o(E)}(_B>=0&&_B<=F)&&L(_B)}function L(_A){for(const gG of document.querySelectorAll('.wizard-step'))gG.style.display='none';let gF=document.getElementById(`wizard-step-${_A}`);gF&&(gF.style.display='block');E=_A;m()}function m(){let gH=document.querySelector('.wizard-progress-bar'),gI=(E/F)*100;gH.style.width=`${gI}%`;document.getElementById('wizard-btn-prev').style.display=E>0?'inline-block':'none';document.getElementById('wizard-btn-next').style.display=E<F?'inline-block':'none';document.getElementById('wizard-btn-finish').style.display=E===F?'inline-block':'none'}function n(gJ){if(gJ===1){let gK=parseFloat(document.getElementById('wizard-capacidade-maxima').value),gL=parseFloat(document.getElementById('wizard-acuracia').value);if(isNaN(gK)||gK<=0){dF('error','O limite da cÃ©lula de carga deve ser um nÃºmero maior que zero.');return!1}if(isNaN(gL)||gL<=0){dF('error','A acurÃ¡cia deve ser um nÃºmero percentual maior que zero.');return!1}}if(gJ===2){let gM=parseInt(document.getElementById('wizard-num-amostras').value),gN=parseFloat(document.getElementById('wizard-tolerancia').value),_C=parseInt(document.getElementById('wizard-timeout').value);if(isNaN(gM)||gM<1){dF('error','O nÃºmero de leituras para mÃ©dia deve ser ao menos 1.');return!1}if(isNaN(gN)||gN<=0){dF('error','A tolerÃ¢ncia de calibraÃ§Ã£o deve ser maior que zero.');return!1}if(isNaN(_C)||_C<1000){dF('error','O timeout de calibraÃ§Ã£o deve ser de no mÃ­nimo 1000 ms.');return!1}}return!0}function o(gO){if(gO===1){let gP=parseFloat(document.getElementById('wizard-capacidade-maxima').value),gQ=document.getElementById('wizard-capacidade-unidade').value,gR=gP;if(gQ==='kg')gR=gP*1000;else gQ==='N'&&(gR=(gP/9.80665)*1000);G.capacidadeMaximaGramas=gR;G.percentualAcuracia=parseFloat(document.getElementById('wizard-acuracia').value)/100}gO===4&&(G.antiNoisingMultiplier=parseFloat(document.getElementById('wizard-anti-noising-multiplier').value));gO===2&&(G.numAmostrasMedia=parseInt(document.getElementById('wizard-num-amostras').value),G.toleranciaEstabilidade=parseFloat(document.getElementById('wizard-tolerancia').value),G.timeoutCalibracao=parseInt(document.getElementById('wizard-timeout').value))}function P(gS){clearTimeout(h);document.getElementById('wizard-loading').style.display=document.getElementById('wizard-error').style.display='none';document.getElementById('wizard-capacidade-maxima').value=gS.capacidadeMaximaGramas||5000;document.getElementById('wizard-acuracia').value=(gS.percentualAcuracia*100).toFixed(3)||0.05;let gT=document.getElementById('wizard-capacidade-maxima'),gU=document.getElementById('wizard-capacidade-unidade'),_d=document.getElementById('wizard-acuracia'),_e=document.createElement('small'),_g=parseFloat(document.getElementById('wizard-capacidade-maxima').value),H=parseFloat(document.getElementById('wizard-acuracia').value)/100,_i=_g*H,J=(_i*1.5).toFixed(2);_d.parentElement.appendChild(_e);let _f=()=>{let gV=parseFloat(gT.value)||0,gW=gU.value,gX=gV,_E=gX*(_D/100);if(gW==='kg')gX=gV*1000;else gW==='N'&&(gX=(gV/9.80665)*1000);let _D=parseFloat(_d.value)||0;_e.textContent=`(Â± ${_E.toFixed(2)} g)`};gT.addEventListener('input',_f);_d.addEventListener('input',_f);_f();gU.addEventListener('change',()=>{let gY=parseFloat(gT.value),gZ=gU.value;if(isNaN(gY))return;if(gZ==='kg')gT.value=gY/1000;else gZ==='g'&&(gT.value=gY*1000)});document.getElementById('wizard-num-amostras').value=gS.numAmostrasMedia||10;document.getElementById('wizard-timeout').value=gS.timeoutCalibracao||5000;document.getElementById('wizard-tolerancia').value=gS.toleranciaEstabilidade||J;document.getElementById('wizard-tolerancia-sugestao').textContent=`SugestÃ£o: ${J} g (baseado em 1.5x o erro da cÃ©lula)`;k(1)}let q=cL;cL=hA=>{q(hA);document.getElementById('wizard-modal').style.display==='block'&&P(hA)};function R(){let hB=document.getElementById('wizard-tare-status');hB.innerHTML='Enviando comando de tara...';cG('t');let hC=hD=>{const{type:hE,payload:hF}=hD.data;if(hE==='dadosDisponiveis'){let hG=hF[0].forca;hB.innerHTML=`âœ… Tara concluÃ­da! Leitura atual: ${hG.toFixed(3)} N`;w.removeEventListener('message',hC)}};w.addEventListener('message',hC)}function S(){let hH=document.getElementById('wizard-calibrate-status'),hI=parseFloat(document.getElementById('wizard-massa-calibracao').value);if(!isNaN(hI)&&hI>0){hH.innerHTML=`Enviando comando de calibraÃ§Ã£o com ${hI}g...`;cG('c',hI);let hJ=hK=>{const{type:hL,payload:hM}=hK.data;if(hL==='dadosDisponiveis'){let hN=hM[0].forca;hH.innerHTML=`âœ… CalibraÃ§Ã£o concluÃ­da! Leitura atual: ${hN.toFixed(3)} N`;w.removeEventListener('message',hJ)}};w.addEventListener('message',hJ)}else dF('error','Informe uma massa de calibraÃ§Ã£o vÃ¡lida.')}async function T(){o(E);let hO={capacidadeMaximaGramas:G.capacidadeMaximaGramas,percentualAcuracia:G.percentualAcuracia,numAmostrasMedia:G.numAmostrasMedia,toleranciaEstabilidade:G.toleranciaEstabilidade,timeoutCalibracao:G.timeoutCalibracao,antiNoisingMultiplier:G.antiNoisingMultiplier};dF('info','Aplicando configuraÃ§Ãµes no dispositivo...');for(const[hP,hQ] of Object.entries(hO))(!B(hQ)&&!isNaN(hQ))&&(await new Promise(hR=>setTimeout(hR,100)),cG('set',{param:hP,value:hQ}));localStorage.setItem('showStartupReminder',document.getElementById('wizard-show-reminder').checked);setTimeout(()=>{dF('success','ConfiguraÃ§Ãµes aplicadas com sucesso!');cG('get_config');j()},1000)}function U(){let hS=document.getElementById('wizard-noise-status');hS.innerHTML='Analisando ruÃ­do... Mantenha a balanÃ§a VAZIA e ESTÃVEL por 5 segundos!';eD();setTimeout(()=>hS.innerHTML=`âœ… AnÃ¡lise de ruÃ­do concluÃ­da! Desvio padrÃ£o: ${bA.toFixed(3)} N`,5000)}let aP,aQ,aR,aS,aT;window.sharedState={forcaAtual:0,overloadAlert:{active:!1,level:0,percent:0,forca:0}};let aW=!1;window.onload=()=>{cC();dD(document.getElementById('padrao'),'abaGrafico');bV();fD();bY('kgf');bZ('deslizante');bO();setInterval(cK,1000);eH();eI();eP();bM();bN();bS();aK=document.querySelector('#abaGrafico .grafico-e-controles');aL=document.querySelector('#abaGrafico .controles-grafico-sessao');aM=aL.querySelector('.btn-grupo');aP=document.getElementById('btn-toggle-labels');aQ=document.getElementById('btn-toggle-display-mode');aR=document.getElementById('btn-toggle-grid');aS=document.getElementById('btn-set-smooth-line');aT=document.getElementById('btn-set-straight-line');dU();dV?.();let hT=document.getElementById('taxa-atualizacao'),hV=document.getElementById('max-data-points-input'),hX=document.getElementById('leituras-container');hT?(hT.value=aN,console.log('[TAXA] Campo encontrado. Valor atual:',aN),hT.addEventListener('change',e=>{let hY=parseInt(e.target.value);!isNaN(hY)&&hY>=10&&hY<=1000?(aN=hY,bP(),bQ(),console.log('[TAXA] Alterada para:',aN,'ms'),dF('info',`Taxa de atualizaÃ§Ã£o alterada para ${aN}ms (${(1000/aN).toFixed(1)} Hz)`)):(e.target.value=aN,dF('error','Valor invÃ¡lido. Use valores entre 10 e 1000 ms.'))}),hT.addEventListener('input',e=>{let hZ=parseInt(e.target.value);if(!isNaN(hZ)&&hZ>=10&&hZ<=1000){let iA=(1000/hZ).toFixed(1),iB=document.getElementById('taxa-info');iB&&(iB.textContent=`â‰ˆ ${iA} atualizaÃ§Ãµes/seg (prÃ©via)`)}})):(console.warn('[TAXA] Campo taxa-atualizacao NÃƒO encontrado no HTML!'));let hU=document.getElementById('btn-exit-fullscreen');hU?.addEventListener('click',eX);hV&&(hV.value=x,hV.addEventListener('change',iC=>{let iD=parseInt(iC.target.value);if(!isNaN(iD)&&iD>0){x=iD;dF('info',`NÃºmero mÃ¡ximo de pontos atualizado para ${x}.`);aF.length>x&&(aF=aF.slice(aF.length-x),V.updateSeries([{data:aF.map(p=>[p[0],dG(p[1],aA)])}]))}else{dF('error','Valor invÃ¡lido para o nÃºmero mÃ¡ximo de pontos.');iC.target.value=x}}));let hW=document.getElementById('btn-open-wizard');hW?.addEventListener('click',I);if(hX){let iE=['kgf','N','gf'];hX.addEventListener('click',()=>{let iF=iE.indexOf(aA),iG=(iF+1)%iE.length,iH=iE[iG];bY(iH);dF('info',`Unidade alterada para ${iH}`)})}let _F=document.getElementById('btn-abrir-modal-sessao');_F?.addEventListener('click',cT)};function bL(){return window.location.hostname.endsWith('github.io')}function bM(){let iI=document.getElementById('theme-toggle'),iJ=localStorage.getItem('theme')||'light';iJ==='dark'&&(document.body.classList.add('dark-mode'),iI.textContent='â˜€ï¸');iI.addEventListener('click',()=>{document.body.classList.toggle('dark-mode');let iK=document.body.classList.contains('dark-mode')?'dark':'light';iI.textContent=iK==='dark'?'â˜€ï¸':'ğŸŒ™';localStorage.setItem('theme',iK);V.updateOptions({chart:{background:'transparent'},theme:{mode:iK}})})}function bN(){let iL=document.getElementById('ws-url'),iM=document.getElementById('btn-salvar-ws-url'),iN=document.getElementById('btn-resetar-ws-url'),iO=document.getElementById('ws-url-controls');if(bL()){iL&&(iL.value='WebSocket desabilitado no GitHub Pages (HTTPS)',iL.disabled=!0,iL.style.backgroundColor='#e9e9e9',iL.style.color='#555',iL.style.cursor='not-allowed',iL.title='ConexÃµes WebSocket sÃ£o desabilitadas em ambientes HTTPS como o GitHub Pages por seguranÃ§a.');iM&&(iM.style.display='none');iN&&(iN.style.display='none');iO&&(iO.style.display='none');console.warn('WebSocket connections are disabled on GitHub Pages.');return}let iP=localStorage.getItem('wsUrl');if(iP)iL.value=iP;else{let iQ=location.hostname;(location.port==='5500'||iQ==='127.0.0.1')&&(iQ='localhost');iL.value=`ws://${iQ}:81`}}function bO(){aO&&clearInterval(aO);aO=setInterval(()=>{w?.postMessage({type:'solicitarDados'})},aN);console.log(`[Intervalo] Iniciado com taxa de ${aN}ms (${(1000/aN).toFixed(1)} Hz)`)}function bP(){aO&&clearInterval(aO);bO()}function bQ(){let iR=document.getElementById('taxa-info');if(iR){let iS=(1000/aN).toFixed(1);iR.textContent=`â‰ˆ ${iS} atualizaÃ§Ãµes/seg`}}let bR='';function bS(){try{bR=window.location.origin;if(location.port==='5500'||location.protocol==='file:'){let iT=localStorage.getItem('wsUrl');if(iT){const{host:iU,protocol:iV}=bT(iT),iW=iV==='wss:'?'https:':'http:',iX='80';bR=`${iW}//${iU}:${iX}`}}}catch(e){console.warn('setupApiBaseUrlHelpers fallback para origem atual:',e);bR=window.location.origin}}function bT(iY){try{let u=iY.trim();(!u.startsWith('ws://')&&!u.startsWith('wss://')&&!u.startsWith('http'))&&(u=`ws://${u}`);let iZ=new URL(u);return{protocol:iZ.protocol,host:iZ.hostname,port:iZ.port}}catch(e){return{protocol:'http:',host:location.hostname,port:''}}}async function bU(jA,jB={}){try{return await fetch(jA,jB)}catch(e){try{return await fetch(jA.startsWith('/')?bR+jA:bR+'/'+jA,jB)}catch(e2){throw e2}}}function bV(){let jC=localStorage.getItem('theme')||'light',jD={series:[{name:'ForÃ§a',data:[]}],chart:{id:'realtime',height:450,type:'line',animations:{enabled:!0,easing:'linear',dynamicAnimation:{speed:400}},toolbar:{show:!0},zoom:{enabled:!0},background:'transparent'},grid:{show:!0,borderColor:'#90A4AE',strokeDashArray:4,xaxis:{lines:{show:!0}},yaxis:{lines:{show:!0}},row:{colors:['#f3f3f3','transparent'],opacity:0.5},column:{colors:['#f3f3f3','transparent'],opacity:0.5}},stroke:{curve:'smooth',width:eR==='line'||eR==='both'?2.5:0},xaxis:{type:'numeric',tickAmount:10,labels:{formatter:jE=>{if(jE%1===0)return parseInt(jE)+'s';return jE.toFixed(1)+'s'}}},yaxis:{labels:{formatter:jF=>{if(Math.abs(jF)<0.001)return`0.000 ${aA}`;if(Math.abs(jF)<0.01)return jF.toFixed(4)+' '+aA;if(Math.abs(jF)<0.1)return jF.toFixed(3)+' '+aA;if(Math.abs(jF)<10)return jF.toFixed(2)+' '+aA;return jF.toFixed(1)+' '+aA}}},dataLabels:{enabled:!1,offsetY:-10,style:{fontSize:'10px'}},markers:{size:eR==='points'||eR==='both'?4:0,colors:['#FF0000']},theme:{mode:jC}};V=new ApexCharts(document.querySelector('#grafico'), jD);V.render()}function bW(){aB=-Infinity;aC=Infinity;aF=[];V.updateSeries([{data:[]}]);cA();dF('info','GrÃ¡fico limpo. (Atalho: L)',3000)}function bX(jG,jH,jI,jJ){let jK=dG(jG,aA),jL=dG(jH,aA),_G=dG(jI,aA),_h=dG(jJ,aA);document.getElementById('forca-atual').textContent=`${jK.toFixed(3)} ${aA}`;document.getElementById('forca-maxima').textContent=`${_G.toFixed(3)} ${aA}`;document.getElementById('forca-minima').textContent=`mÃ­n: ${_h.toFixed(3)} ${aA}`}function bY(jM){aA=jM;document.dispatchEvent(new CustomEvent('unidade-alterada', {detail:{unidade:jM}}));let jN=aF.map(jO=>[jO[0],dG(jO[1],aA)]);V.updateSeries([{data:jN}]);V.updateOptions({yaxis:{labels:{formatter:jP=>jP.toFixed(3)+' '+aA}}});bX(aD,aE,aB,aC)}function bZ(jQ){if(y==='acumulado')z=!0;else jQ==='deslizante'&&(z=!1);y=jQ;for(const b of document.querySelectorAll('#btn-deslizante, #btn-acumulado, #btn-pausado'))b.classList.remove('ativo');document.getElementById(`btn-${jQ}`).classList.add('ativo');aH=(jQ==='pausado');let jR=document.getElementById('max-data-points-input'),jS=document.getElementById('max-data-points-label');if(jQ==='acumulado'||(jQ==='pausado'&&z)){jR.disabled=!0;jR.style.fontWeight='bold';jR.style.color='var(--cor-info)';if(jS){jQ==='pausado'?jS.textContent='â¸ï¸ Pontos Acumulados (Pausado):':jS.textContent='ğŸ“Š Pontos Acumulados:';jS.style.color='var(--cor-info)';jS.style.fontWeight='bold'}cA()}else{jR.disabled=!1;jR.style.fontWeight='normal';jR.style.color='';jR.value=x;jS&&(jS.textContent='Max Pontos:',jS.style.color='',jS.style.fontWeight='normal')}}function cA(){if(y==='acumulado'||(y==='pausado'&&z)){let jT=document.getElementById('max-data-points-input');jT&&(jT.value=aF.length)}}function cB(jU=null){jU!==null&&(aH=!1);aH?(bZ('deslizante'),dF('info','GrÃ¡fico retomado (Deslizante). (Atalho: P)')):(bZ('pausado'),dF('info','GrÃ¡fico pausado. (Atalho: P)'))}function cC(){if(window.Worker)if(!w){w=new Worker('dataWorker.js');w.onmessage=cE;w.postMessage({type:'set_github_pages_mode',payload:{isGitHubPages:bL()}});if(bL()){console.warn('[Worker] WebSocket desabilitado no GitHub Pages. NÃ£o serÃ¡ feita conexÃ£o.');w.postMessage({type:'set_ws_url',payload:{url:null}});aN=50;setInterval(()=>w.postMessage({type:'solicitarDados'}),aN);return}let jV=localStorage.getItem('wsUrl');if(jV)w.postMessage({type:'set_ws_url',payload:{url:jV}});else{let jW=location.hostname;(location.port==='5500'||jW==='127.0.0.1')&&(jW='localhost');let jX=`ws://${jW}:81`;w.postMessage({type:'set_ws_url',payload:{url:jX}})}aN=50;setInterval(()=>w.postMessage({type:'solicitarDados'}),aN);console.log('[Worker] Conectado com taxa inicial de 50ms para responsividade')}else dF('error','Seu navegador nÃ£o suporta Web Workers.')}function cD(){if(window.Worker)if(!w){w=new Worker('dataWorker.js');w.onmessage=cE;let jY=localStorage.getItem('wsUrl');jY&&w.postMessage({type:'set_ws_url',payload:{url:jY}});setInterval(()=>w.postMessage({type:'solicitarDados'}),200)}else dF('error','Seu navegador nÃ£o suporta Web Workers.')}function cE(jZ){const{type:kA,payload:kB,status:kC,message:kD}=jZ.data,kE=kD;(kA==='mysql_save_success'||kA==='mysql_save_error')&&(kE=kB.message);switch(kA) {case 'dadosDisponiveis':kB.forEach(cH);break;case 'rps':document.getElementById('leituras-por-segundo').textContent=kB;break;case 'config':console.log('ConfiguraÃ§Ã£o recebida:',kB);cL(kB);break;case 'status':document.getElementById('balanca-status').textContent=kE||kC;(kC==='connected'||kC==='disconnected')&&cJ(kC==='connected');if(kE){dF((kC==='error'||kC==='disconnected')?'error':'info',kE)}eO(kE);break;case 'mysql_status_update':aU=kB;cF(aU);break;case 'mysql_save_success':dF('success',`SessÃ£o "${kE}" salva no MySQL!`);fD();break;case 'mysql_save_error':dF('error',`Erro ao salvar sessÃ£o "${kE}" no MySQL.`);break;case 'debug':console.log('[Worker Debug]:',kD);break;default:console.warn('Mensagem desconhecida do worker:',jZ.data)}}function cF(kF){let kG=document.getElementById('mysql-indicator'),kH=document.getElementById('mysql-text');kG&&(kG.className='status-indicator '+(kF?'conectado':'desconectado'),kG.title=kF?'MySQL Conectado':'MySQL Desconectado');kH&&(kH.textContent=kF?'Conectado':'Desconectado')}function cG(kI,kJ=null){if(!w){dF('error','Worker nÃ£o estÃ¡ conectado.');return}let kK={cmd:kI};if(kJ!==null)kI==='save_session_to_mysql'?kK.sessionData=kJ:kK.value=kJ;w.postMessage({type:'sendCommand',payload:kK})}function cH(kL){if(aH)return;let{tempo:kM,forca:kN,ema:kO}=kL,kP=dR((kN/9.80665)*1000),kR=aW?eA(kN):kN,_I=(_H/1000)*9.80665,_j=Math.abs((kR/_I)*100);kN=(kP/1000)*9.80665;let kQ=dR((kO/9.80665)*1000);kO=(kQ/1000)*9.80665;aX&&eB(kN);kR>aB&&(aB=kR);kR<aC&&(aC=kR);aD=kR;aE=kO;bX(kR,kO,aB,aC);window.sharedState.forcaAtual=kR;document.dispatchEvent(new CustomEvent('forca-atualizada', {detail:{forcaN:kR,unidade:aA}}));let _H=parseFloat(document.getElementById('param-capacidade-maxima')?.value)||5000;dH(kR);dN(_j,kR);dL(kR,_j);aF.push([kM,kR]);(y==='deslizante'&&aF.length>x)&&aF.shift();aI.push([kM,kR]);!aJ&&(aJ=requestAnimationFrame(cI));if(aG){let kS=document.getElementById('tabela').querySelector('tbody'),kT=kS.insertRow(0),kV=`${kU.getUTCDate()}`.padStart(2,'0'),kW=`${kU.getUTCMonth()+1}`.padStart(2,'0'),kX=kU.getUTCFullYear(),kY=`${kU.getUTCHours()}`.padStart(2,'0'),kZ=`${kU.getUTCMinutes()}`.padStart(2,'0'),lA=`${kU.getUTCSeconds()}`.padStart(2,'0'),_J=`${kU.getUTCMilliseconds()}`.padStart(3,'0');let kU=new Date;kT.insertCell(0).innerText=`${kV}/${kW}/${kX} ${kY}:${kZ}:${lA}.${_J}`;kT.insertCell(1).innerText=+kM.toFixed(3);kT.insertCell(2).innerText=+kR.toFixed(6);kT.insertCell(3).innerText=+(kR/9.80665)*1000.toFixed(eS);kT.insertCell(4).innerText=+kR/9.80665.toFixed(6);kS.rows.length>5000&&kS.deleteRow(kS.rows.length-1)}}function cI(){if(aI.length===0){aJ=null;return}let lB=aF.map(p=>[p[0],dG(p[1],aA)]);V.updateSeries([{data:lB}]);cA();aI=[];aJ=null}function cJ(lC){let lD=document.getElementById('ws-indicator'),lE=document.getElementById('ws-text');document.body.classList.toggle('desconectado',!lC);lD.classList.toggle('conectado',lC);lD.title=lC?'Conectado':'Desconectado';lE&&(lE.textContent=lC?'Conectado':'Desconectado');lC?eM():eL()}function cK(){w?.postMessage({type:'getRPS'})}function cL(lF){let lG=lL=>(lL!==null&&!B(lL))?lL:'',lI=parseFloat(lF.percentualAcuracia),lJ=parseFloat(lF.toleranciaEstabilidade),lK=parseFloat(lF.timeoutCalibracao);document.getElementById('param-conversao').value=lG(lF.conversionFactor);document.getElementById('param-gravidade').value=lG(lF.gravity);document.getElementById('param-offset').value=lG(lF.tareOffset);document.getElementById('param-leituras-estaveis').value=lG(lF.leiturasEstaveis);document.getElementById('param-tolerancia').value=lG(lF.toleranciaEstabilidade);document.getElementById('param-num-amostras').value=lG(lF.numAmostrasMedia);document.getElementById('param-timeout').value=lG(lF.timeoutCalibracao);document.getElementById('param-capacidade-maxima').value=lG(lF.capacidadeMaximaGramas);document.getElementById('param-acuracia').value=lG(lF.percentualAcuracia);let lH=parseFloat(lF.capacidadeMaximaGramas);bD=(!isNaN(lH)&&lH>0)?lH:5000.0;bE=(!isNaN(lI)&&lI>0)?lI:0.05;console.log('[updateConfigForm] Valores recebidos do ESP:');console.log('  Capacidade:',lF.capacidadeMaximaGramas,'â†’',bD);console.log('  AcurÃ¡cia:',lF.percentualAcuracia,'â†’',bE);console.log('  TolerÃ¢ncia:',lF.toleranciaEstabilidade,'â†’',lJ.toFixed(2));console.log('  Timeout (ms):',lF.timeoutCalibracao,'â†’',lK.toFixed(0));console.log('  Erro Absoluto calculado:',(bD*bE).toFixed(2),'g');dO();dP();dQ();dU();document.getElementById('abaControles').classList.remove('config-loading')}function cM(){cG('t');dF('info','Comando de Tara enviado. (Atalho: Shift + T)');setTimeout(()=>cG('get_config'),1000)}function cN(){let lM=parseFloat(document.getElementById('massaCalibracao').value);!isNaN(lM)&&lM>0?(cG('c',lM),dF('info',`Comando de calibraÃ§Ã£o com ${lM}g enviado. (Atalho: Shift + C)`),setTimeout(()=>cG('get_config'),1000)):(dF('error','Informe uma massa de calibraÃ§Ã£o vÃ¡lida.'))}async function cO(){let lN={conversionFactor:'param-conversao',gravity:'param-gravidade',tareOffset:'param-offset',leiturasEstaveis:'param-leituras-estaveis',toleranciaEstabilidade:'param-tolerancia',numAmostrasMedia:'param-num-amostras',timeoutCalibracao:'param-timeout',capacidadeMaximaGramas:'param-capacidade-maxima',percentualAcuracia:'param-acuracia'};dF('info','Enviando parÃ¢metros para o dispositivo...');for(const[lO,lP] of Object.entries(lN)){let lQ=document.getElementById(lP).value.trim();if(lQ!==''){let lR=parseFloat(lQ.replace(',','.'));!isNaN(lR)&&(await new Promise(lS=>setTimeout(lS,100)),cG('set',{param:lO,value:lR}))}}setTimeout(()=>{dF('success','ParÃ¢metros salvos! Atualizando valores...');cG('get_config')},1000)}function cP(){let lT=document.getElementById('ws-url').value;localStorage.setItem('wsUrl',lT);w?.postMessage({type:'set_ws_url',payload:{url:lT}});dF('success','URL do WebSocket salva. A conexÃ£o serÃ¡ reiniciada.')}function cQ(){localStorage.removeItem('wsUrl');let lU=window.location.hostname||'localhost',lV=`ws://${lU}:81`,lW=document.getElementById('ws-url');lW.value=lV;w?.postMessage({type:'set_ws_url',payload:{url:lV}});dF('success',`URL do WebSocket restaurada para o padrÃ£o: ${lV}`)}function cR(){let lX=document.getElementById('modal-importacao');lX.style.display='block'}function cS(){let lY=document.getElementById('modal-importacao');lY.style.display='none'}function cT(){let lZ=document.getElementById('modal-nova-sessao');lZ.style.display='block'}function cU(){let mA=document.getElementById('modal-nova-sessao');mA.style.display='none'}function cY(){cX&&(clearInterval(cX),cX=null);let mB=document.getElementById('countdown-overlay');mB&&(mB.style.display='none');document.getElementById('btn-abrir-modal-sessao').disabled=!1;document.getElementById('btn-encerrar-sessao').disabled=!0;dF('warning','GravaÃ§Ã£o cancelada pelo usuÃ¡rio.')}function cZ(mC,mD){let mE=document.getElementById('countdown-overlay'),mF=document.getElementById('countdown-number'),mG=document.getElementById('countdown-hand'),mH=document.getElementById('btn-cancelar-countdown');if(!mE||!mF||!mG){console.error('Elementos do countdown nÃ£o encontrados!');mD();return}mH.onclick=cY;mE.style.display='flex';let mI=~~mC;cX&&clearInterval(cX);cX=setInterval(()=>{mI>1?(mF.textContent=mI,eK(800,100,0.1)):(mF.textContent='',eK(1200,200,0.3));mI--;if(mI<0){cX&&clearInterval(cX);cX=null;mE.style.display='none';mD()}},1000)}function dA(){let mJ=document.getElementById('sessao-nome').value.trim(),mK=parseFloat(document.getElementById('sessao-delay').value)||0,mL=parseFloat(document.getElementById('sessao-timer').value)||0;if(!mJ){dF('error','Por favor, insira um nome para a sessÃ£o.');document.getElementById('sessao-nome').focus();return}cU();document.getElementById('btn-abrir-modal-sessao').disabled=!0;let mM=()=>{bW();document.getElementById('tabela').querySelector('tbody').innerHTML='';aG=!0;document.getElementById('btn-encerrar-sessao').disabled=!1;let mN=document.getElementById('mensagem-gravacao'),mO=document.getElementById('tempo-gravacao');mN.style.display='flex';let mP=0;mO.textContent=`Gravando ${mP}s...`;cW&&clearInterval(cW);cW=setInterval(()=>{mP++;mO.textContent=`Gravando ${mP}s...`},1000);dF('success',`SessÃ£o "${mJ}" iniciada!`);if(mL>0){dF('info',`A gravaÃ§Ã£o serÃ¡ encerrada automaticamente em ${mL} segundos.`);cV&&clearTimeout(cV);cV=setTimeout(()=>{dF('info','Tempo de gravaÃ§Ã£o finalizado. Encerrando sessÃ£o...');dB()},mL*1000)}};mK>1?(cZ(mK,mM)):(dF('info',`GravaÃ§Ã£o iniciando...`),mM())}async function dB(){if(!aG)return;cV&&(clearTimeout(cV),cV=null);cW&&(clearInterval(cW),cW=null);let mQ=document.getElementById('mensagem-gravacao'),mS=document.getElementById('tabela').querySelector('tbody');mQ&&(mQ.style.display='none');let mR=document.getElementById('sessao-nome').value.trim();if(mS.rows.length>0){let mT=await dC(mR,mS);(mT&&aU)&&(dF('info','Enviando sessÃ£o "'+mT.nome+'" para o MySQL...'),cG('save_session_to_mysql',mT))}else dF('info','Nenhum dado foi gravado. Nada foi salvo.');aG=document.getElementById('btn-abrir-modal-sessao').disabled=!1;document.getElementById('btn-encerrar-sessao').disabled=!0;document.getElementById('sessao-nome').value=''}function dC(mU,mV){let mW=[...mV.rows].map(mZ=>({timestamp:mZ.cells[0].innerText,tempo_esp:mZ.cells[1].innerText,newtons:mZ.cells[2].innerText,grama_forca:mZ.cells[3].innerText,quilo_forca:mZ.cells[4].innerText})).reverse(),mX={diameter:parseFloat(document.getElementById('sessao-meta-diametro')?.value)||null,length:parseFloat(document.getElementById('sessao-meta-comprimento')?.value)||null,manufacturer:document.getElementById('sessao-meta-fabricante')?.value?.trim()||null,propweight:parseFloat(document.getElementById('sessao-meta-propelente')?.value)||null,totalweight:parseFloat(document.getElementById('sessao-meta-peso-total')?.value)||null,description:document.getElementById('sessao-meta-descricao')?.value?.trim()||null,observations:document.getElementById('sessao-meta-observacoes')?.value?.trim()||null},mY={id:Date.now(),nome:mU,timestamp:new Date().toISOString(),data_modificacao:new Date().toISOString(),dadosTabela:mW,metadadosMotor:mX,savedToMysql:aU};try{let nA=JSON.parse(localStorage.getItem('balancaGravacoes'))||[];nA.push(mY);localStorage.setItem('balancaGravacoes',JSON.stringify(nA));dF('success',`SessÃ£o "${mU}" salva localmente!`);return mY}catch(e){dF('error','Erro ao salvar. O Local Storage pode estar cheio.');return null}}function dD(nB,nC){for(const nE of document.querySelectorAll('.tabcontent')){nE.style.display='none';nE.classList.remove('active')}for(const nF of document.querySelectorAll('.tablink'))nF.classList.remove('active');let nD=document.getElementById(nC);if(nC==='abaControles'){nD.classList.add('config-loading');cG('get_config')}else nC==='abaGravacoes';nD.style.display='block';nD.classList.add('active');nB.classList.add('active')}function dE(){window.open('jogos/index.html','jogos','width=1400,height=900,scrollbars=yes,resizable=yes')}function dF(nG,nH,nI=5000){let nJ=document.getElementById('notification-area'),nK=document.createElement('div');nK.className=`notification ${nG}`;nK.innerHTML=nH;nJ.prepend(nK);setTimeout(()=>{nK.style.transition='opacity 0.5s';nK.style.opacity='0';setTimeout(()=>nK.remove(),500)},nI)}function dG(nL,nM){let nN=101.9716;if(nM==='gf')return nL*nN;if(nM==='kgf')return nL*(nN/1000);return nL}function dH(nO){let nP=parseFloat(document.getElementById('param-capacidade-maxima')?.value)||5000,nQ=(nP/1000)*9.80665,nR=Math.abs((nO/nQ)*100),nS=document.querySelectorAll('.leituras-valores > div');for(const nT of nS)nT.classList.remove('alerta-70','alerta-80','alerta-90','alerta-limite');if(nR>=100)for(const nU of nS)nU.classList.add('alerta-limite');else if(nR>=90)for(const nV of nS)nV.classList.add('alerta-90');else if(nR>=80)for(const nW of nS)nW.classList.add('alerta-80');else nR>=70}let dI=!1;function dL(nX,nY){let nZ=document.getElementById('modal-alerta-sobrecarga'),oA=nZ.querySelector('.modal-sobrecarga-content'),oB=document.getElementById('modal-sobrecarga-titulo'),oC=document.getElementById('modal-sobrecarga-mensagem'),oD=parseFloat(document.getElementById('param-capacidade-maxima')?.value)||5000,oE=(oD/1000)*9.80665,oF=dG(Math.abs(nX),aA),oG=dG(oE,aA),_l=0;document.getElementById('modal-sobrecarga-valor-atual').textContent=oF.toFixed(3)+' '+aA;document.getElementById('modal-sobrecarga-valor-limite').textContent=oG.toFixed(3)+' '+aA;document.getElementById('modal-sobrecarga-percentual').textContent=nY.toFixed(1)+'%';let K=document.getElementById('modal-sobrecarga-barra-progresso');K.style.width=Math.min(nY,100)+'%';if(nY>=100)_l=100;else if(nY>=90)_l=90;else nY>=80&&(_l=80);window.sharedState.overloadAlert={active:nY>=80,level:_l,percent:nY,forca:nX,capacidade:oE,displayUnit:aA};let M=Date.now()-dK;if(dJ&&nY<70){dJ=!1;dK=0}else if(dJ&&M<10000)return;if(nY>=80&&!dI){nZ.classList.add('ativo');dI=!0;dJ=!1;try{let oH=new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjeR1/LMeSwFJHfH8N2RQAoUXrTp66hVFApGn+DyvmwhBjeR1/LMeSwFJHfH8N2RQAoUXrTp66hVFApGn+DyvmwhBjeR1/LMeSwFJHfH8N2RQAoUXrTp66hVFApGn+DyvmwhBjeR1/LMeSwFJHfH8N2RQAoUXrTp66hVFApGn+DyvmwhBjeR1/LMeSwFJHfH8N2RQAoUXrTp66hVFApGn+DyvmwhBjeR1/LMeSwFJHfH8N2RQAoUXrTp66hVFApGn+DyvmwhBjeR1/LMeSwFJHfH8N2RQAoUXrTp66hVFApGn+DyvmwhBjeR1/LMeSwFJHfH8N2RQAoUXrTp66hVFApGn+DyvmwhBjeR1/LMeSwFJHfH8N2RQAoUXrTp66hVFApGn+DyvmwhBjeR1/LMeSwFJHfH8N2RQAoUXrTp66hVFApGn+DyvmwhBjeR1/LMeSwFJHfH8N2RQAoUXrTp66hVFApGn+DyvmwhBjeR1/LMeSwFJHfH8N2RQAoUXrTp66hVFApGn+DyvmwhBjeR1/LMeSwFJHfH8N2RQAoUXrTp66hVFApGn+DyvmwhBjeR1/LMeSwFJHfH8N2RQAoUXrTp66hVFApGn+DyvmwhBjeR1/LMeSwFJHfH8N2RQAoUXrTp66hVFA==');oH.play().catch(()=>{})}catch(e){}}if(dI){oA.classList.remove('alerta-80','alerta-90','alerta-100');if(nY>=100){oA.classList.add('alerta-100');oB.textContent='ğŸš¨ LIMITE EXCEDIDO! PARE IMEDIATAMENTE! ğŸš¨';oC.innerHTML=`
        â›” <strong>LIMITE DA CÃ‰LULA ULTRAPASSADO!</strong><br>
        <strong style="font-size: 1.15rem; color: #7f1d1d;">RISCO CRÃTICO DE DESTRUIÃ‡ÃƒO DO EQUIPAMENTO!</strong>
      `}else if(nY>=90){oA.classList.add('alerta-90');oB.textContent='ğŸš¨ PERIGO: MUITO PRÃ“XIMO DO LIMITE! ğŸš¨';oC.innerHTML=`
        âš ï¸ VocÃª estÃ¡ em zona crÃ­tica!<br>
        <strong>RISCO IMINENTE DE DANOS PERMANENTES!</strong>
      `}else nY>=80&&(oA.classList.add('alerta-80'),oB.textContent='âš ï¸ ATENÃ‡ÃƒO: APROXIMANDO DO LIMITE! âš ï¸',oC.innerHTML=`
        âš ï¸ VocÃª estÃ¡ prÃ³ximo do limite da cÃ©lula de carga!<br>
        <strong>RISCO DE DANOS PERMANENTES AO EQUIPAMENTO!</strong>
      `);nY<75&&dM(!1)}}function dM(oI=!0){const oJ=document.getElementById('modal-alerta-sobrecarga');oJ.classList.remove('ativo');dI=!1;ultimoNivelAlerta=0;oI&&(dJ=!0,dK=Date.now(),console.log('[MODAL] Fechado pelo usuÃ¡rio - nÃ£o reabrirÃ¡ por 10 segundos ou atÃ© carga cair abaixo de 70%'))}function dN(oK,oL){let oM=document.getElementById('barra-esforco-fill'),oN=document.getElementById('barra-esforco-texto');if(!oM||!oN)return;let oO=dG(Math.abs(oL),aA);oM.style.width=Math.min(oK,100)+'%';oN.textContent=`${oO.toFixed(2)} ${aA} | ${oK.toFixed(1)}%`;oM.classList.remove('nivel-50','nivel-60','nivel-70','nivel-80','nivel-90','nivel-100');if(oK>=100)oM.classList.add('nivel-100');else if(oK>=90)oM.classList.add('nivel-90');else if(oK>=80)oM.classList.add('nivel-80');else if(oK>=70)oM.classList.add('nivel-70');else if(oK>=60)oM.classList.add('nivel-60');else oK>=50&&oM.classList.add('nivel-50')}function dO(){let oP=parseFloat(document.getElementById('param-tolerancia').value),oQ=parseFloat(document.getElementById('param-conversao').value),oR=document.getElementById('tolerancia-em-gramas');(oR&&!isNaN(oP)&&!isNaN(oQ)&&oQ!==0)&&(oR.textContent=`â‰ˆ ${(oP/oQ).toFixed(3)} gf`)}function dP(){let oS=parseFloat(document.getElementById('param-capacidade-maxima').value),oT=document.getElementById('capacidade-em-kg');if(oT&&!isNaN(oS)){oT.textContent=`â‰ˆ ${(oS/1000).toFixed(2)} kg`;(Number.isFinite(oS)&&oS>0)&&(bD=oS,dU(),console.log('[UI] capacidadeMaximaGramas atualizada via input â†’',bD))}}function dQ(){let oU=parseFloat(document.getElementById('param-capacidade-maxima').value),oV=parseFloat(document.getElementById('param-acuracia').value),oW=document.getElementById('erro-absoluto');if(oW&&!isNaN(oU)&&!isNaN(oV)){oW.textContent=`Erro: Â±${(oU*oV).toFixed(2)} g`;(Number.isFinite(oV)&&oV>0)&&(bE=oV,dU(),console.log('[UI] percentualAcuracia atualizado via input â†’',bE))}}function dR(oX){let oY=oX;bF&&(oY=dS(oY));bG&&(oY=dT(oY));return oY}function dS(oZ){let pA=bD*bE,pB=Math.abs(oZ)<=pA?0:oZ;(pB===0&&oZ!==0)&&console.log('[ZonaMorta] Valor',oZ.toFixed(3),'g â†’ 0 (limite:',pA.toFixed(2),'g)');return pB}function dT(pC){let pD=bD*bE;return parseFloat(pC.toFixed((pD>=1)?1:(pD>=0.1)?2:3))}function dU(){let pE=bD*bE,pG=document.getElementById('info-arredondamento');eS=(pE>=1)?1:(pE>=0.1)?2:3;let pF=document.getElementById('info-zona-morta');pF&&(pF.textContent=bF?`âœ“ Zona Morta (Â±${pE.toFixed(2)}g)`:'âœ— Zona Morta',pF.style.color=bF?'#27ae60':'#95a5a6');pG&&(pG.textContent=bG?`âœ“ Arredondamento (${eS} casas)`:'âœ— Arredondamento',pG.style.color=bG?'#27ae60':'#95a5a6')}function dV(){let pH=document.getElementById('btn-zona-morta');pH&&(pH.textContent='Zona Morta: '+(bF?'ON':'OFF'),pH.style.background=bF?'#27ae60':'#95a5a6');let pI=document.getElementById('btn-arredondamento');pI&&(pI.textContent='Arredondar: '+(bG?'ON':'OFF'),pI.style.background=bG?'#27ae60':'#95a5a6')}function dW(){bF=!bF;let pJ=document.getElementById('btn-zona-morta');pJ.textContent='Zona Morta: '+(bF?'ON':'OFF');pJ.style.background=bF?'#27ae60':'#95a5a6';dU()}function dX(){bG=!bG;let pK=document.getElementById('btn-arredondamento');pK.textContent='Arredondar: '+(bG?'ON':'OFF');pK.style.background=bG?'#27ae60':'#95a5a6';dU()}function dY(){let pL=bD*bE;console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');console.log('ğŸ” DEBUG ZONA MORTA');console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');console.log('ğŸ“Š ParÃ¢metros Globais:');console.log('  capacidadeMaximaGramas:',bD);console.log('  percentualAcuracia:',bE);console.log('  Erro Absoluto (Zona Morta):',pL.toFixed(2),'g');console.log('  Filtro Ativo:',bF);console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');console.log('ğŸ§ª Testes de Valores:');let pM=[0,0.1,0.5,1,2,5,10,50,100];for(const pN of pM){let pO=dS(pN),pP=pO===0?'â†’ ZERADO':'â†’ MANTIDO';console.log(`  ${pN.toFixed(1)}g ${pP} (resultado: ${pO.toFixed(3)}g)`)}console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');dF('info',`Debug Zona Morta concluÃ­do! Limite atual: Â±${pL.toFixed(2)}g. Veja o console.`,5000)}function dZ(){aW=!aW;let pQ=document.getElementById('btn-anti-noising');aW?(pQ.textContent='Anti-Noising: ON',pQ.classList.add('btn-sucesso')):(pQ.textContent='Anti-Noising: OFF',pQ.classList.remove('btn-sucesso'))}function eA(pR){if(bA===0)return pR;let pS=bA*bC;return Math.abs(pR-bB)<=pS?0:pR-bB}function eB(pT){aY.push(pT);aY.length>aZ&&aY.shift();if(aY.length<10)return;bB=aY.reduce((s,v)=>s+v,0)/aY.length;bA=Math.sqrt(aY.reduce((s,v)=>s+Math.pow(v-bB,2),0)/aY.length);eC()}function eC(){}function eD(){aX=!0;aY=[];dF('info','Analisando ruÃ­do... Mantenha a balanÃ§a VAZIA e ESTÃVEL por 5 segundos!',5000);setTimeout(()=>{aX=!1;dF('success','âœ… RuÃ­do calibrado!')},5000)}function eE(){aY=[];bA=bB=0;aX=!1;dF('info','AnÃ¡lise de ruÃ­do resetada')}function eF(pU){bC=parseFloat(pU)}function eG(){let pV=document.getElementById('anti-noising-multiplier'),pW=document.getElementById('info-multiplier');if(pV&&pW){let pX=parseFloat(pV.value);pW.textContent=`Valor atual: ${pX.toFixed(1)}x desvio padrÃ£o`}}function eH(){}function eI(){try{bI=new (window.AudioContext||window.webkitAudioContext)}catch(e){console.warn('Ãudio nÃ£o disponÃ­vel')}}function eJ(){bH=document.getElementById('audio-avisos').checked;(bH&&bI?.state==='suspended')&&bI.resume();dF('info','ğŸ”Š Avisos sonoros '+(bH?'ativados':'desativados'))}function eK(pY=800,pZ=100,qA=0.2){if(!bH||!bI)return;let qB=bI.createOscillator(),qC=bI.createGain();qB.connect(qC);qC.connect(bI.destination);qB.frequency.value=pY;qC.gain.setValueAtTime(qA,bI.currentTime);qC.gain.exponentialRampToValueAtTime(0.01,bI.currentTime+pZ/1000);qB.start();qB.stop(bI.currentTime+pZ/1000)}function eL(){eK(400,100);setTimeout(()=>eK(300,100),150)}function eM(){eK(600,100);setTimeout(()=>eK(800,100),120)}function eN(){eK(500,150)}function eO(qD){let qE=qD?.includes('nÃ£o estabilizando');if(qE&&!bJ){bK++;bK>=3&&document.getElementById('alerta-estabilizacao').classList.add('ativo')}else !qE&&(bK=0,document.getElementById('alerta-estabilizacao').classList.remove('ativo'));bJ=!qE}function eP(){document.addEventListener('keydown',qF=>{if(qF.target.tagName==='INPUT'||qF.target.tagName==='TEXTAREA')return;let qG=qF.key.toLowerCase(),qH=document.getElementById('fullscreen-chart-modal');if(qG==='escape'&&qH.classList.contains('active')){qF.preventDefault();eX();return}if(qF.shiftKey)if(qG==='t'){qF.preventDefault();cM()}else if(qG==='c'){qF.preventDefault();cN()}else if(qG==='a'){qF.preventDefault();eD()}else qG==='d'&&(qF.preventDefault(),dY());else if(!qF.ctrlKey&&!qF.metaKey)if(qG==='l'){qF.preventDefault();bW()}else qG==='p'&&(qF.preventDefault(),cB())})}let eQ=!1;function eU(){eQ=!eQ;V.updateOptions({dataLabels:{enabled:eQ,offsetY:-10,style:{fontSize:'10px'},formatter:function(qI){return qI.toFixed(6)+' '+aA}}})}function eV(){let qJ=['points','line','both'],qK=qJ.indexOf(eR),qL=(qK+1)%qJ.length,qN='',qO=0,qP=0;eR=qJ[qL];let qM=document.getElementById('btn-toggle-display-mode');switch(eR) {case 'points':qN='Modo: Somente Pontos';qP=4;qO=0;break;case 'line':qN='Modo: Somente Linha';qP=0;qO=2.5;break;case 'both':qN='Modo: Linha + Pontos';qP=4;qO=2.5;break}qM.textContent=qN;V.updateOptions({stroke:{width:qO},markers:{size:qP}});dF('info',`Modo de exibiÃ§Ã£o do grÃ¡fico: ${qN.replace('Modo: ','')}.`)}function eW(qQ){V.updateOptions({stroke:{curve:qQ}})}function eX(){let qR=document.querySelector('#grafico'),qS=document.getElementById('fullscreen-chart-modal'),qT=document.getElementById('btn-toggle-fullscreen'),qU=document.body,qV=aK.querySelector('.btn-grupo');if(!qS.classList.contains('active')){if(!aK||!aL||!aM){console.error('Original chart containers or controls parent not found!');return}qV.appendChild(aP);qV.appendChild(aQ);qV.appendChild(aR);qV.appendChild(aS);qV.appendChild(aT);qS.appendChild(aK);aL.style.display='none';qS.classList.add('active');qU.classList.add('no-scroll');qT&&(qT.textContent='Sair da Tela Cheia');requestAnimationFrame(()=>{V.updateOptions({chart:{height:'100%',width:'100%'}});setTimeout(()=>V.windowResize(),50)})}else{let qW=document.getElementById('abaGrafico');aM.appendChild(aP);aM.appendChild(aQ);aM.appendChild(aR);aM.appendChild(aS);aM.appendChild(aT);qW.appendChild(aK);aL.style.display='flex';qS.classList.remove('active');qU.classList.remove('no-scroll');qT&&(qT.textContent='Tela Cheia');requestAnimationFrame(()=>{V.updateOptions({chart:{height:450,width:'100%'}});setTimeout(()=>V.windowResize(),50)})}}function eY(){eT=!eT;V.updateOptions({grid:{show:eT}});let qX=document.getElementById('btn-toggle-grid');qX.textContent='Grade: '+(eT?'ON':'OFF');dF('info','Grade do grÃ¡fico: '+(eT?'ON':'OFF')+'.')}function eZ(qY){if(qY==='auto')V.updateOptions({yaxis:{min:undefined,max:undefined}});else if(qY==='fixed'){if(!bD||bD<=0){dF('error','Capacidade mÃ¡xima da cÃ©lula nÃ£o definida. Verifique os parÃ¢metros.');return}let qZ,rA=9.80665;qZ=dG((bD/1000)*rA,aA);V.updateOptions({yaxis:{min:0,max:qZ}})}}function fA(rB){if(!rB)return null;let s=c(rB)?rB:`${rB}`;s=s.replace(' ','T');s=s.replace(/\.(\d{3})\d+$/,'.$1');!/Z$/i.test(s)&&(s+='Z');return new Date(s)}function fB(rC){if(!rC)return'';let rD=`${rC.getUTCDate()}`.padStart(2,'0'),rE=`${rC.getUTCMonth()+1}`.padStart(2,'0'),rF=rC.getUTCFullYear(),rG=`${rC.getUTCHours()}`.padStart(2,'0'),rH=`${rC.getUTCMinutes()}`.padStart(2,'0'),rI=`${rC.getUTCSeconds()}`.padStart(2,'0'),rJ=`${rC.getUTCMilliseconds()}`.padStart(3,'0');return`${rD}/${rE}/${rF} ${rG}:${rH}:${rI}.${rJ}`}async function fC(){try{let rK=await bU('/api/sessoes');if(!rK.ok)throw Error('Erro na rede: '+rK.statusText);return await rK.json()}catch(rL){console.error('Erro ao buscar sessÃµes do DB:',rL);dF('error','NÃ£o foi possÃ­vel buscar as sessÃµes do banco de dados.');return[]}}async function fD(){let rM=document.getElementById('lista-gravacoes'),rQ=[...rP.values()].sort((a,b)=>b.id-a.id);rM.innerHTML='<p>Carregando sessÃµes...</p>';let rN=JSON.parse(localStorage.getItem('balancaGravacoes'))||[];let rO=await fC();let rP=new Map;for(const rR of rN)rP.set(rR.id,{...rR,source:'local', inLocal:!0});for(const rS of rO){let rT=rP.get(rS.id);if(rT){let rU=rT.data_modificacao?new Date(rT.data_modificacao):new Date(0),rV=rS.data_modificacao?new Date(rS.data_modificacao):new Date(0),rW=Math.abs(rU-rV)>1000;rP.set(rS.id,{...rT,...rS,source:'both',inDb:!0,hasConflict:rW,localModified:rT.data_modificacao,dbModified:rS.data_modificacao})}else rP.set(rS.id,{...rS,source:'db', inDb:!0})}if(rQ.length===0){rM.innerHTML='<p>Nenhuma gravaÃ§Ã£o encontrada (local ou no banco de dados).</p>';return}for(const rX of rQ)if(rX.inDb&&(!rX.dadosTabela||rX.dadosTabela.length===0))try{let rY=await bU(`/api/sessoes/${rX.id}/leituras`);if(rY.ok){let rZ=await rY.json();rX.dadosTabela=rZ.map(r=>({timestamp:fB(fA(r.timestamp)),tempo_esp:r.tempo,newtons:r.forca,grama_forca:(r.forca/9.80665*1000),quilo_forca:(r.forca/9.80665)}))}}catch(e){console.warn(`NÃ£o foi possÃ­vel carregar leituras da sessÃ£o ${rX.id}:`,e)}rM.innerHTML=rQ.map(sA=>{let sB=`${sA.inLocal?'<span title="Salvo Localmente" style="margin-right: 5px;">ğŸ’¾</span>':''}${sA.inDb?'<span title="Salvo no Banco de Dados" style="margin-right: 5px;">â˜ï¸</span>':''}`;let sC=sA.data_inicio||sA.timestamp,sD=sC?fA(sC).toLocaleString('pt-BR'):'N/D',sE='N/A',sF='N/A',sG='#95a5a6',sI=sH.name?`
      <p style="font-size: 0.75rem; color: var(--cor-texto-secundario); margin-top: 5px;">
        ğŸš€ Motor: ${sH.name||'N/D'} â€¢ âŒ€${sH.diameter||'N/D'}mm â€¢ L${sH.length||'N/D'}mm â€¢
        Prop: ${sH.propweight||'N/D'}kg â€¢ Total: ${sH.totalweight||'N/D'}kg â€¢ ${sH.manufacturer||'N/D'}
      </p> 
    `:'',sJ=sA.hasConflict?`
      <span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 8px;">
        âš ï¸ CONFLITO
      </span>
    `:'';if(sA.dadosTabela&&sA.dadosTabela.length>0){let sK=processarDadosSimples(sA.dadosTabela),sL=calcularAreaSobCurva(sK.tempos,sK.newtons,!1),sM=calcularMetricasPropulsao(sL);sE=sL.impulsoTotal.toFixed(2);sF=sM.classificacaoMotor.classe;sG=sM.classificacaoMotor.cor}let sH=sA.metadadosMotor||{};return`
      <div class="card-gravacao" style="display: flex; justify-content: space-between; align-items: center; background: var(--cor-fundo-card); padding: 15px; border-radius: 8px; box-shadow: rgba(0, 0, 0, 0.1) 0px 2px 10px; margin-bottom: 10px; border-left: 5px solid ${sG};" id="session-${sA.id}">
        <div style="flex: 1;">
            <p style="font-weight: 600; margin-bottom: 5px;">${sB}${sA.nome} <span style="font-size: 0.75rem; background: ${sG}; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">CLASSE ${sF}</span>${sJ}</p>
            <p style="font-size: 0.875rem; color: var(--cor-texto-secundario);">
                ${sD} â€¢ Impulso Total: ${sE} Nâ‹…s
            </p>
            ${sI}
        </div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            ${sA.hasConflict?`<button onclick="resolverConflito(${sA.id})" title="Resolver Conflito de SincronizaÃ§Ã£o" class="btn btn-aviso">âš ï¸ Resolver Conflito</button>`:''}
            <button onclick="visualizarSessao(${sA.id}, '${sA.source}')" title="Carregar para AnÃ¡lise/GrÃ¡fico" class="btn btn-info">ï¸ Ver</button>
            <button onclick="editarMetadadosMotor(${sA.id})" title="Editar Metadados do Motor" class="btn btn-secundario">âš™ï¸ Metadados</button>
            <button onclick="exportarImagemSessao(${sA.id}, '${sA.source}')" title="Exportar GrÃ¡fico em PNG" class="btn btn-primario">ï¸ PNG</button>
            <button onclick="gerarRelatorioPdf(${sA.id}, '${sA.source}')" title="Exportar RelatÃ³rio PDF" class="btn btn-secundario"> PDF</button>
            <button onclick="exportarJSON(${sA.id}, '${sA.source}')" title="Exportar Dados em JSON" class="btn btn-sucesso"> JSON</button>
            <button onclick="exportarCSV(${sA.id}, '${sA.source}')" title="Exportar Dados em CSV" class="btn btn-sucesso"> CSV</button>
            <button onclick="exportarEng(${sA.id}, '${sA.source}')" title="Exportar Curva de Empuxo para OpenRocket/RASAero" class="btn btn-aviso"> ENG</button>
            ${sA.inLocal&&!sA.inDb?`<button class="btn btn-info btn-small"
                ${!aU?'disabled title="MySQL desconectado"':'title="Salvar do LocalStorage para o Banco de Dados"'}
                onclick="salvarNoDB(${sA.id})">
                ğŸ’¾ âœ â˜ï¸ Salvar no BD
             </button>
             <button class="btn btn-perigo btn-small" title="Excluir do LocalStorage" onclick="deleteLocalSession(${sA.id})">ğŸ—‘ï¸ Excluir do Local</button>`:''}
            ${sA.inDb&&!sA.inLocal?`<button class="btn btn-perigo btn-small" title="Excluir do Banco de Dados" onclick="deleteDbSession(${sA.id})">ğŸ—‘ï¸ Excluir do BD</button>
             <button class="btn btn-info btn-small"
                title="Salvar do Banco de Dados para o LocalStorage"
                onclick="salvarNoLocalStorage(${sA.id})">
                â˜ï¸ âœ ğŸ’¾ Salvar Local
             </button>`:''}
            ${sA.inDb&&sA.inLocal?`<button class="btn btn-perigo btn-small" title="Excluir do Banco de Dados" onclick="deleteDbSession(${sA.id})">ğŸ—‘ï¸ Excluir do BD</button>
             <button class="btn btn-perigo btn-small" title="Excluir do LocalStorage" onclick="deleteLocalSession(${sA.id})">ğŸ—‘ï¸ Excluir do Local</button>`:''}
        </div>
      </div>
    `}).join('')}function fE(sN){fS(sN)}function fF(sO){fT(sO)}async function fG(sP){let sQ=JSON.parse(localStorage.getItem('balancaGravacoes'))||[],sR=sQ.find(s=>s.id===sP);if(!sR)try{let sT=await bU(`/api/sessoes/${sP}`);sT.ok&&(sR=await sT.json())}catch(e){console.error('Erro ao buscar sessÃ£o do DB:',e)}if(!sR){dF('error','SessÃ£o nÃ£o encontrada para editar metadados.');return}let sS=sR.metadadosMotor||{};document.body.insertAdjacentHTML('beforeend',`
    <div id="modal-metadados" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; overflow-y: auto;">
      <div style="background: var(--cor-fundo); padding: 30px; border-radius: 12px; max-width: 700px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); margin: 20px;">
        <h2 style="margin-top: 0; color: var(--cor-titulo);">âš™ï¸ Metadados do Motor - ${sR.nome}</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nome do Motor</label>
            <input type="text" id="meta-name" value="${sS.name||''}" placeholder="Ex: NFB_20" style="width: 100%; padding: 8px; border: 1px solid var(--cor-borda); border-radius: 4px;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Fabricante</label>
            <input type="text" id="meta-manufacturer" value="${sS.manufacturer||'GFIG-IFC'}" style="width: 100%; padding: 8px; border: 1px solid var(--cor-borda); border-radius: 4px;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">DiÃ¢metro (mm)</label>
            <input type="number" id="meta-diameter" value="${sS.diameter||45}" step="0.1" style="width: 100%; padding: 8px; border: 1px solid var(--cor-borda); border-radius: 4px;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Comprimento (mm)</label>
            <input type="number" id="meta-length" value="${sS.length||200}" step="1" style="width: 100%; padding: 8px; border: 1px solid var(--cor-borda); border-radius: 4px;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Delay (s)</label>
            <input type="number" id="meta-delay" value="${sS.delay||0}" step="0.1" style="width: 100%; padding: 8px; border: 1px solid var(--cor-borda); border-radius: 4px;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Peso Propelente (kg)</label>
            <input type="number" id="meta-propweight" value="${sS.propweight||0.1}" step="0.001" style="width: 100%; padding: 8px; border: 1px solid var(--cor-borda); border-radius: 4px;">
          </div>
          <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Peso Total (kg)</label>
            <input type="number" id="meta-totalweight" value="${sS.totalweight||0.25}" step="0.001" style="width: 100%; padding: 8px; border: 1px solid var(--cor-borda); border-radius: 4px;">
          </div>
          <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">ğŸ“ DescriÃ§Ã£o</label>
            <textarea id="meta-description" placeholder="DescriÃ§Ã£o detalhada do motor..." style="width: 100%; padding: 8px; border: 1px solid var(--cor-borda); border-radius: 4px; min-height: 80px; resize: vertical; font-family: inherit;">${sS.description||''}</textarea>
          </div>
          <div style="grid-column: 1 / -1;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">ğŸ’¬ ObservaÃ§Ãµes</label>
            <textarea id="meta-observations" placeholder="ObservaÃ§Ãµes adicionais sobre o teste..." style="width: 100%; padding: 8px; border: 1px solid var(--cor-borda); border-radius: 4px; min-height: 80px; resize: vertical; font-family: inherit;">${sS.observations||''}</textarea>
          </div>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button onclick="fecharModalMetadados()" class="btn btn-secundario">Cancelar</button>
          <button onclick="salvarMetadadosMotor(${sP})" class="btn btn-sucesso">ğŸ’¾ Salvar Metadados</button>
        </div>
      </div>
    </div>
  `)}function fH(){let sU=document.getElementById('modal-metadados');sU?.remove()}async function fI(sV){let sW=JSON.parse(localStorage.getItem('balancaGravacoes'))||[],sX=sW.findIndex(s=>s.id===sV),sY={name:document.getElementById('meta-name').value.trim(),manufacturer:document.getElementById('meta-manufacturer').value.trim(),diameter:parseFloat(document.getElementById('meta-diameter').value)||45,length:parseFloat(document.getElementById('meta-length').value)||200,delay:parseFloat(document.getElementById('meta-delay').value)||0,propweight:parseFloat(document.getElementById('meta-propweight').value)||0.1,totalweight:parseFloat(document.getElementById('meta-totalweight').value)||0.25,description:document.getElementById('meta-description').value.trim(),observations:document.getElementById('meta-observations').value.trim()},sZ=null,tA=sX!==-1;if(tA){sW[sX].metadadosMotor=sY;sW[sX].data_modificacao=new Date().toISOString();sZ=sW[sX];try{localStorage.setItem('balancaGravacoes',JSON.stringify(sW));dF('success','Metadados do motor salvos localmente!')}catch(e){dF('error','Erro ao salvar metadados localmente: '+e.message);fH();return}}if(!sZ)try{let tB=await bU(`/api/sessoes/${sV}`);if(tB.ok){sZ=await tB.json();sZ.metadadosMotor=sY;(sZ.data_inicio&&!sZ.timestamp)&&(sZ.timestamp=sZ.data_inicio);!sZ.nome&&(sZ.nome=`SessÃ£o ${sV}`)}}catch(e){console.error('Erro ao buscar sessÃ£o do DB:',e)}else sZ.metadadosMotor=sY;if(aU&&sZ){if(!sZ.dadosTabela||sZ.dadosTabela.length===0)try{let tC=await bU(`/api/sessoes/${sV}/leituras`);if(tC.ok){let tD=await tC.json();sZ.dadosTabela=tD.map(r=>({timestamp:fB(fA(r.timestamp)),tempo_esp:r.tempo,newtons:r.forca,grama_forca:(r.forca/9.80665*1000),quilo_forca:(r.forca/9.80665)}))}}catch(e){console.warn('NÃ£o foi possÃ­vel carregar leituras:',e)}console.log('Enviando para o banco:',sZ);cG('save_session_to_mysql',sZ);dF('info','Atualizando metadados no banco de dados...')}else !aU&&dF('warning','MySQL desconectado. Metadados salvos apenas localmente.');fH();setTimeout(()=>fD(),500)}async function fJ(tE,tF){dF('info','Gerando relatÃ³rio PNG com anÃ¡lise de propulsÃ£o...');let tG=await fL(tE,tF);if(!tG){dF('error','SessÃ£o nÃ£o encontrada para exportar PNG.');return}if(typeof exportarImagemSessao==='function')exportarImagemSessao(tG.id);else{console.warn('[PNG] FunÃ§Ã£o exportarImagemSessao nÃ£o encontrada, usando mÃ©todo legado');let tH=tG.dadosTabela.map(d=>[d.tempo_esp,d.newtons]),tI=document.createElement('div');tI.style.position='absolute';tI.style.left='-9999px';tI.style.width='800px';tI.style.height='600px';document.body.appendChild(tI);let tJ={series:[{name:'ForÃ§a',data:tH}],chart:{type:'line',height:'100%',width:'100%',background:'#fff'},title:{text:'GrÃ¡fico da SessÃ£o: '+tG.nome,align:'center'},xaxis:{title:{text:'Tempo (s)'}},yaxis:{title:{text:'ForÃ§a (N)'}}};let tK=new ApexCharts(tI, tJ);tK.render().then(()=>tK.dataURI().then(({imgURI:tL})=>{let a=document.createElement('a');a.href=tL;a.download=`grafico_${tG.nome.replace(/\W/g,'_')}.png`;document.body.appendChild(a);a.click();document.body.removeChild(a);tK.destroy();document.body.removeChild(tI);dF('success','GrÃ¡fico exportado como PNG!')}))}}async function fK(tM,tN){let tO=await fL(tM,tN);if(!tO){dF('error','SessÃ£o nÃ£o encontrada para exportar JSON.');return}let tP=JSON.stringify(tO,null,2),tQ=URL.createObjectURL(new Blob([tP], {type:'application/json;charset=utf-8;'})),a=document.createElement('a');a.href=tQ;a.download=tO.nome.replace(/\W/g,'_')+'.json';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(tQ);dF('success','Arquivo JSON para "'+tO.nome+'" gerado!')}async function fL(tR,tS){let tT=null;if(tS==='local'||tS==='both'){let tU=JSON.parse(localStorage.getItem('balancaGravacoes'))||[];tT=tU.find(s=>s.id===tR)}if(!tT&&(tS==='db'||tS==='both'))try{let tV=await bU('/api/sessoes');if(!tV.ok)throw Error('Falha ao carregar detalhes da sessÃ£o do DB para exportaÃ§Ã£o.');let tW=await tV.json();let tX=tW.find(s=>s.id===tR);if(tX){let tY=await bU(`/api/sessoes/${tR}/leituras`);if(!tY.ok)throw Error('Falha ao carregar leituras do DB para exportaÃ§Ã£o.');let tZ=await tY.json();tT={id:tX.id,nome:tX.nome,timestamp:tX.data_inicio,data_modificacao:tX.data_modificacao||new Date().toISOString(),dadosTabela:tZ.map(r=>({timestamp:fB(fA(r.timestamp)),tempo_esp:r.tempo,newtons:r.forca,grama_forca:(r.forca/9.80665*1000),quilo_forca:(r.forca/9.80665)})),metadadosMotor:tX.metadadosMotor||{},savedToMysql:!0}}}catch(uA){console.error('Erro ao buscar sessÃ£o do DB para exportaÃ§Ã£o:',uA);dF('error',`Erro ao carregar sessÃ£o ${tR} do DB para exportaÃ§Ã£o.`);return null}return tT}async function fM(uB){try{let uC=JSON.parse(localStorage.getItem('balancaGravacoes')||'[]'),uD=uC.find(g=>`${g.id}`===`${uB}`),uF=uE.map(([t,f])=>[t,dG(f,aA)]),uH=dG(aB,aA),uI=dG(aC,aA),uJ=document.getElementById('forca-atual'),uK=document.getElementById('forca-ems'),uL=document.getElementById('forca-maxima'),_k=document.getElementById('forca-minima'),_m=document.getElementById('padrao');if(!uD)try{let uM=await bU(`/api/sessoes/${uB}`,{cache:'no-store'});uM.ok&&(uD=await uM.json())}catch(e){console.error('Erro ao buscar metadados da sessÃ£o no DB:',e)}if(uD&&(!_(uD.dadosTabela)||uD.dadosTabela.length===0))try{let uN=await bU(`/api/sessoes/${uB}/leituras`,{cache:'no-store'});if(uN.ok){let uO=await uN.json();uD.dadosTabela=uO.map(r=>({timestamp:new Date(r.timestamp).toLocaleString('pt-BR',{hour12:!1}).replace(', ',' '),tempo_esp:r.tempo,newtons:r.forca,grama_forca:(r.forca/9.80665*1000).toFixed(3),quilo_forca:(r.forca/9.80665).toFixed(6)}))}}catch(e){console.error('Erro ao buscar leituras da sessÃ£o no DB:',e)}if(!uD||!_(uD.dadosTabela)||uD.dadosTabela.length===0){dF('error','SessÃ£o nÃ£o encontrada ou sem dados.');return}let uE=uD.dadosTabela.map(l=>[+l.tempo_esp,+l.newtons]).filter(([t,f])=>Number.isFinite(t)&&Number.isFinite(f)).sort((a,b)=>a[0]-b[0]);if(uE.length<2){dF('error','Dados insuficientes para plotagem.');return}aF=uE.map(([t,f])=>[t,f]);aB=Math.max(...uE.map(p=>p[1]));aC=Math.min(...uE.map(p=>p[1]));V.updateSeries([{data:uF}]);let uG=dG(uE[uE.length-1][1],aA);uJ&&(uJ.textContent=uG.toFixed(3));uK&&(uK.textContent=uG.toFixed(3));uL&&(uL.textContent=uH.toFixed(3));_k&&(_k.textContent=`mÃ­n: ${uI.toFixed(3)}`);let _L=document.querySelector('#tabela tbody');if(_L){_L.innerHTML='';let uP=(uQ,uR=1000)=>{let uS=Math.min(uQ+uR,uE.length),uT=document.createDocumentFragment();for(let i=uQ;i<uS;i++){const[t,N]=uE[i],uU=(N/9.80665)*1000,uV=(N/9.80665),uW=document.createElement('tr'),uX=document.createElement('td'),uZ=document.createElement('td'),vB=document.createElement('td');uX.textContent=uD.dadosTabela[i]?.timestamp||'';const uY=document.createElement('td');uY.textContent=t.toFixed(3);uZ.textContent=N.toFixed(6);const vA=document.createElement('td');vA.textContent=uU.toFixed(3);vB.textContent=uV.toFixed(6);uW.appendChild(uX);uW.appendChild(uY);uW.appendChild(uZ);uW.appendChild(vA);uW.appendChild(vB);uT.appendChild(uW)}_L.appendChild(uT);uS<uE.length&&setTimeout(()=>uP(uS,uR),0)};uP(0)}(_m&&A(dD))&&dD(_m,'abaGrafico');eZ?.('auto');dF('success',`SessÃ£o "${uD.nome||uB}" carregada.`)}catch(vC){console.error('Erro em visualizarSessao:',vC);dF('error','Falha ao carregar a sessÃ£o: '+(vC?.message?vC.message:'erro desconhecido'))}cB(!0)}async function fN(vD,vE){let vF=await fL(vD,vE);if(!vF){dF('error','SessÃ£o nÃ£o encontrada para exportaÃ§Ã£o .ENG.');return}let vG=vF.metadadosMotor||{},vH=';name\tdiameter\tlength\tdelay\tpropweight\ttotalweight\tmanufacturer\n',a=document.createElement('a');vH+=(vG.name||'Motor').trim()+'\t';vH+=(vG.diameter||45).toFixed(1)+'\t';vH+=(vG.length||200).toFixed(1)+'\t';vH+=(vG.delay||0).toFixed(1)+'\t';vH+=(vG.propweight||0.1).toFixed(5)+'\t';vH+=(vG.totalweight||0.25).toFixed(5)+'\t';vH+=(vG.manufacturer||'GFIG').trim()+'\n';vH+=';\n';vH+='; Arquivo gerado pelo sistema GFIG\n';vH+=`; Data: ${new Date().toLocaleString('pt-BR')}\n`;vH+='; SessÃ£o: '+vF.nome+'\n';vG.massaPropelente&&(vH+=`; Massa de propelente informada: ${vG.massaPropelente.toFixed(2)} g\n`);vH+='; NÃºmero de leituras: '+vF.dadosTabela.length+'\n';vH+=';\n';for(const vJ of vF.dadosTabela){let vK=parseFloat(vJ.tempo_esp)||0,vL=parseFloat(vJ.newtons)||0;vH+=vK.toFixed(5)+'\t'+vL.toFixed(5)+'\n'}let vI=URL.createObjectURL(new Blob([vH], {type:'text/plain;charset=utf-8'}));a.href=vI;a.download=(vG.name||vF.nome.replace(/\W/g,'_'))+'.eng';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(vI);dF('success','Arquivo .ENG compatÃ­vel com OpenRocket gerado!')}async function fO(vM,vN){let vO=await fL(vM,vN);if(!vO){dF('error','SessÃ£o nÃ£o encontrada para relatÃ³rio PDF.');return}dF('info','Gerando relatÃ³rio PDF com grÃ¡fico...',2000);let vP=processarDadosSimples(vO.dadosTabela),vQ=calcularAreaSobCurva(vP.tempos,vP.newtons,!1),vR=null;vO.metadadosMotor?.massaPropelente&&(vR=vO.metadadosMotor.massaPropelente/1000);let vS=calcularMetricasPropulsao(vQ,vR);gerarGraficoParaPDF(vO,vP,vQ,vS,vT=>{let vU=window.open('','_blank');vU.document.write(gerarHTMLRelatorioCompleto(vO,vP,vQ,vS,vT));vU.document.close();vU.onload=()=>setTimeout(()=>vU.print(),500);dF('success','RelatÃ³rio pronto! Use "Salvar como PDF" no diÃ¡logo',5000)})}async function fP(vV,vW){let vX=await fL(vV,vW);if(!vX){dF('error','SessÃ£o nÃ£o encontrada para exportaÃ§Ã£o CSV.');return}let vY='Timestamp,Tempo ESP (s),Newtons (N),Grama-forÃ§a (gf),Quilo-forÃ§a (kgf)\n',a=document.createElement('a');for(const wA of vX.dadosTabela)vY+=wA.timestamp+','+wA.tempo_esp+','+wA.newtons+','+wA.grama_forca+','+wA.quilo_forca+'\n';let vZ=URL.createObjectURL(new Blob([vY], {type:'text/csv;charset=utf-8;'}));a.href=vZ;a.download=vX.nome.replace(/\W/g,'_')+'.csv';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(vZ);dF('success','Arquivo CSV para "'+vX.nome+'" gerado!')}function fQ(wB){if(!confirm(`Tem certeza que deseja excluir a sessÃ£o ${wB} do Local Storage?`))return;let wC=JSON.parse(localStorage.getItem('balancaGravacoes'))||[];wC=wC.filter(s=>s.id!==wB);localStorage.setItem('balancaGravacoes',JSON.stringify(wC));dF('success',`SessÃ£o ${wB} excluÃ­da do Local Storage.`);fD()}async function fR(wD){if(!confirm(`Tem certeza que deseja excluir a sessÃ£o ${wD} do banco de dados? Esta aÃ§Ã£o nÃ£o pode ser desfeita.`))return;try{let wE=await bU(`/api/sessoes/${wD}`,{method:'DELETE'});if(!wE.ok)throw Error('Falha ao excluir a sessÃ£o do DB.');dF('success',`SessÃ£o ${wD} excluÃ­da do banco de dados.`);fD()}catch(wF){console.error('Erro ao excluir sessÃ£o do DB:',wF);dF('error',`Erro ao excluir a sessÃ£o ${wD} do DB.`)}}async function fS(wG){try{let wH=await bU('/api/sessoes');if(!wH.ok)throw Error('Falha ao carregar detalhes da sessÃ£o do DB para salvar localmente.');let wI=await wH.json();let wJ=wI.find(s=>s.id===wG),wM={id:wJ.id,nome:wJ.nome,timestamp:wJ.data_inicio,data_modificacao:wJ.data_modificacao||new Date().toISOString(),dadosTabela:wL.map(r=>({timestamp:fB(fA(r.timestamp)),tempo_esp:r.tempo,newtons:r.forca,grama_forca:(r.forca/9.80665*1000),quilo_forca:(r.forca/9.80665)})),metadadosMotor:wJ.metadadosMotor||{},savedToMysql:!0},wN=JSON.parse(localStorage.getItem('balancaGravacoes'))||[],wO=wN.findIndex(s=>s.id===wG);if(!wJ){dF('error','SessÃ£o do DB nÃ£o encontrada para salvar localmente.');return}let wK=await bU(`/api/sessoes/${wG}/leituras`);if(!wK.ok)throw Error('Falha ao carregar leituras do DB para salvar localmente.');let wL=await wK.json();wO===-1?(wN.push(wM),dF('success','SessÃ£o "'+wJ.nome+'" salva localmente!')):(wN[wO]=wM,dF('success','SessÃ£o "'+wJ.nome+'" atualizada localmente!'));localStorage.setItem('balancaGravacoes',JSON.stringify(wN));fD()}catch(wP){console.error('Erro ao salvar sessÃ£o do DB localmente:',wP);dF('error',`Erro ao salvar sessÃ£o ${wG} localmente.`)}}function fT(wQ){let wR=JSON.parse(localStorage.getItem('balancaGravacoes'))||[],wS=wR.find(s=>s.id===wQ);if(!wS){dF('error','SessÃ£o local nÃ£o encontrada para salvar no DB.');return}aU?(dF('info','Enviando sessÃ£o "'+wS.nome+'" para o MySQL...'),cG('save_session_to_mysql',wS)):(dF('error','NÃ£o foi possÃ­vel salvar no MySQL: Banco de dados desconectado.'))}async function fU(wT){let wU=JSON.parse(localStorage.getItem('balancaGravacoes'))||[],wV=wU.find(s=>s.id===wT),wW=null,wY=wW.data_modificacao?new Date(wW.data_modificacao).toLocaleString('pt-BR'):'Desconhecida',wZ=wV.metadadosMotor||{},xA=wW.metadadosMotor||{},xB=xE=>!B(xE)&&xE!==null&&xE!==''?xE:'N/D';try{let xD=await bU(`/api/sessoes/${wT}`);xD.ok&&(wW=await xD.json())}catch(e){console.error('Erro ao buscar sessÃ£o do DB:',e);dF('error','Erro ao buscar dados do banco para comparaÃ§Ã£o.');return}if(!wV||!wW){dF('error','NÃ£o foi possÃ­vel carregar ambas as versÃµes para comparaÃ§Ã£o.');return}let wX=wV.data_modificacao?new Date(wV.data_modificacao).toLocaleString('pt-BR'):'Desconhecida';let xC=`
    <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 0.85rem;">
      <strong style="color: #3498db;">ğŸš€ Metadados do Motor:</strong>
      <div style="margin-top: 5px; line-height: 1.6;">
        <div><strong>Nome:</strong> ${xB(wZ.name)}</div>
        <div><strong>DiÃ¢metro:</strong> ${xB(wZ.diameter)} mm</div>
        <div><strong>Comprimento:</strong> ${xB(wZ.length)} mm</div>
        <div><strong>Delay:</strong> ${xB(wZ.delay)} s</div>
        <div><strong>Peso Propelente:</strong> ${xB(wZ.propweight)} kg</div>
        <div><strong>Peso Total:</strong> ${xB(wZ.totalweight)} kg</div>
        <div><strong>Fabricante:</strong> ${xB(wZ.manufacturer)}</div>
        ${wZ.description?`<div style="margin-top: 5px;"><strong>DescriÃ§Ã£o:</strong> ${wZ.description}</div>`:''}
        ${wZ.observations?`<div style="margin-top: 5px;"><strong>ObservaÃ§Ãµes:</strong> ${wZ.observations}</div>`:''}
      </div>
    </div>
  `;let _K=`
    <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 0.85rem;">
      <strong style="color: #9b59b6;">ğŸš€ Metadados do Motor:</strong>
      <div style="margin-top: 5px; line-height: 1.6;">
        <div><strong>Nome:</strong> ${xB(xA.name)}</div>
        <div><strong>DiÃ¢metro:</strong> ${xB(xA.diameter)} mm</div>
        <div><strong>Comprimento:</strong> ${xB(xA.length)} mm</div>
        <div><strong>Delay:</strong> ${xB(xA.delay)} s</div>
        <div><strong>Peso Propelente:</strong> ${xB(xA.propweight)} kg</div>
        <div><strong>Peso Total:</strong> ${xB(xA.totalweight)} kg</div>
        <div><strong>Fabricante:</strong> ${xB(xA.manufacturer)}</div>
        ${xA.description?`<div style="margin-top: 5px;"><strong>DescriÃ§Ã£o:</strong> ${xA.description}</div>`:''}
        ${xA.observations?`<div style="margin-top: 5px;"><strong>ObservaÃ§Ãµes:</strong> ${xA.observations}</div>`:''}
      </div>
    </div>
  `;document.body.insertAdjacentHTML('beforeend',`
    <div id="modal-conflito" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;">
      <div style="background: var(--cor-fundo); padding: 30px; border-radius: 12px; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
        <h2 style="margin-top: 0; color: #e74c3c;">âš ï¸ Conflito de SincronizaÃ§Ã£o Detectado</h2>
        <p style="color: var(--cor-texto); margin-bottom: 20px;">
          A sessÃ£o "<strong>${wV.nome}</strong>" possui versÃµes diferentes no LocalStorage e no Banco de Dados.
          Escolha qual versÃ£o deseja manter:
        </p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
          <div style="border: 2px solid #3498db; border-radius: 8px; padding: 15px; background: rgba(52, 152, 219, 0.1);">
            <h3 style="margin-top: 0; color: #3498db; font-size: 1.1rem;">ğŸ’¾ VersÃ£o Local</h3>
            <p style="margin: 5px 0;"><strong>Modificada em:</strong> ${wX}</p>
            <p style="margin: 5px 0; font-size: 0.9rem; color: var(--cor-texto-secundario);">
              Dados salvos no navegador deste dispositivo.
            </p>
            ${xC}
            <button onclick="resolverConflito_UsarLocal(${wT})" class="btn btn-primario" style="width: 100%; margin-top: 10px;">
              âœ“ Usar VersÃ£o Local
            </button>
          </div>

          <div style="border: 2px solid #9b59b6; border-radius: 8px; padding: 15px; background: rgba(155, 89, 182, 0.1);">
            <h3 style="margin-top: 0; color: #9b59b6; font-size: 1.1rem;">â˜ï¸ VersÃ£o do Banco</h3>
            <p style="margin: 5px 0;"><strong>Modificada em:</strong> ${wY}</p>
            <p style="margin: 5px 0; font-size: 0.9rem; color: var(--cor-texto-secundario);">
              Dados salvos no banco de dados (sincronizados).
            </p>
            ${_K}
            <button onclick="resolverConflito_UsarDB(${wT})" class="btn btn-secundario" style="width: 100%; margin-top: 10px;">
              âœ“ Usar VersÃ£o do Banco
            </button>
          </div>
        </div>

        <div style="display: flex; gap: 10px; justify-content: center;">
          <button onclick="fecharModalConflito()" class="btn btn-perigo">âœ— Cancelar</button>
        </div>
      </div>
    </div>
  `)}function fV(){let xF=document.getElementById('modal-conflito');xF?.remove()}function fW(xG){let xH=JSON.parse(localStorage.getItem('balancaGravacoes'))||[],xI=xH.find(s=>s.id===xG);if(!xI){dF('error','SessÃ£o local nÃ£o encontrada.');fV();return}xI.data_modificacao=new Date().toISOString();let xJ=xH.findIndex(s=>s.id===xG);xH[xJ]=xI;localStorage.setItem('balancaGravacoes',JSON.stringify(xH));aU?(cG('save_session_to_mysql',xI),dF('success','VersÃ£o local enviada para o banco de dados.')):(dF('warning','MySQL desconectado. VersÃ£o local mantida, mas nÃ£o sincronizada.'));fV();setTimeout(()=>fD(),500)}async function fX(xK){try{let xL=await bU(`/api/sessoes/${xK}`);if(!xL.ok)throw Error('Erro ao buscar sessÃ£o do banco');let xM=await xL.json();let xN=await bU(`/api/sessoes/${xK}/leituras`);if(xN.ok){let xQ=await xN.json();xM.dadosTabela=xQ.map(r=>({timestamp:fB(fA(r.timestamp)),tempo_esp:r.tempo,newtons:r.forca,grama_forca:(r.forca/9.80665*1000),quilo_forca:(r.forca/9.80665)}))}(xM.data_inicio&&!xM.timestamp)&&(xM.timestamp=xM.data_inicio);!xM.data_modificacao&&(xM.data_modificacao=new Date().toISOString());let xO=JSON.parse(localStorage.getItem('balancaGravacoes'))||[],xP=xO.findIndex(s=>s.id===xK);xP!==-1?xO[xP]=xM:xO.push(xM);localStorage.setItem('balancaGravacoes',JSON.stringify(xO));dF('success','VersÃ£o do banco baixada para o LocalStorage.');fV();setTimeout(()=>fD(),500)}catch(xR){console.error('Erro ao buscar sessÃ£o do DB:',xR);dF('error','Erro ao baixar versÃ£o do banco de dados.');fV()}}function fY(){let xS=document.getElementById('importar-arquivo-motor'),xT=document.getElementById('nome-importacao'),xU=xS.files[0],xV=xT.value.trim();if(!xU||!xV){dF('error','Por favor, selecione um arquivo e insira um nome para a importaÃ§Ã£o.');return}let xW=new FileReader;xW.onload=e=>{let xX=e.target.result,xY=xX.split('\n').filter(line=>line.trim()!==''),xZ=xY.map((yB,yC)=>{let yD=yB.trim().split(/\s+/);if(yD.length>=2)return{timestamp:new Date(Date.now()+yC).toLocaleString('pt-BR',{hour12:!1}).replace(', ',' '),tempo_esp:parseFloat(yD[0]),newtons:parseFloat(yD[1]),grama_forca:parseFloat(yD[1])/9.80665*1000,quilo_forca:parseFloat(yD[1])/9.80665};return null}).filter(Boolean);if(xZ.length===0){dF('error','Nenhum dado vÃ¡lido encontrado no arquivo importado.');return}let yA={id:Date.now(),nome:xV,timestamp:new Date().toISOString(),data_modificacao:new Date().toISOString(),dadosTabela:xZ,metadadosMotor:{},source:'local',inLocal:!0,inDb:!1};try{let yE=JSON.parse(localStorage.getItem('balancaGravacoes'))||[];yE.push(yA);localStorage.setItem('balancaGravacoes',JSON.stringify(yE));dF('success',`SessÃ£o "${xV}" importada e salva localmente!`);aU&&(dF('info',`Enviando sessÃ£o importada "${xV}" para o MySQL...`),cG('save_session_to_mysql',yA));fD();xS.value=xT.value=''}catch(e){dF('error','Erro ao salvar importaÃ§Ã£o. O Local Storage pode estar cheio.')}};xW.readAsText(xU)}function fZ(){let yF=document.getElementById('importar-json'),yG=yF.files[0];if(!yG){dF('error','Por favor, selecione um arquivo JSON para importar.');return}let yH=new FileReader;yH.onload=e=>{try{let yI=JSON.parse(e.target.result),yK=JSON.parse(localStorage.getItem('balancaGravacoes'))||[],yL=yK.some(g=>g.nome===yJ.nome);if(!yI.nome||!yI.dadosTabela||!_(yI.dadosTabela)){dF('error','Arquivo JSON invÃ¡lido. Certifique-se de que Ã© uma exportaÃ§Ã£o vÃ¡lida.');return}let yJ={...yI,id:Date.now(),data_modificacao:new Date().toISOString(),source:'local',inLocal:!0,inDb:!1};!yJ.timestamp&&(yJ.timestamp=new Date().toISOString());if(yL){let yM=confirm(`JÃ¡ existe uma gravaÃ§Ã£o com o nome "${yJ.nome}". Deseja importar mesmo assim com um nome diferente?`);if(yM)yJ.nome=`${yJ.nome} (importada ${new Date().toLocaleTimeString('pt-BR')})`;else{yF.value='';return}}yK.push(yJ);localStorage.setItem('balancaGravacoes',JSON.stringify(yK));dF('success',`GravaÃ§Ã£o "${yJ.nome}" importada com sucesso! (${yJ.dadosTabela.length} pontos)`);aU&&(dF('info',`Enviando gravaÃ§Ã£o "${yJ.nome}" para o MySQL...`),cG('save_session_to_mysql',yJ));fD();yF.value=''}catch(yN){console.error('Erro ao importar JSON:',yN);dF('error',`Erro ao importar arquivo JSON: ${yN.message}`);yF.value=''}};yH.readAsText(yG)}async function gA(){try{let yO=await bU('/api/time');if(yO.ok){let yP=await yO.json();let yQ=new Date(yP.time);let yR=new Date;aV=yQ.getTime()-yR.getTime();gB()}}catch(yS){console.error('Erro ao buscar hora do servidor:',yS);document.getElementById('server-clock').textContent='Erro'}}function gB(){let yT=new Date(Date.now()+aV);let yU=`${yT.getHours()}`.padStart(2,'0'),yV=`${yT.getMinutes()}`.padStart(2,'0'),yW=`${yT.getSeconds()}`.padStart(2,'0'),yX=document.getElementById('server-clock');yX&&(yX.textContent=`${yU}:${yV}:${yW}`)}async function gC(){let yY=new Date;let yZ=`${yY.getHours()}`.padStart(2,'0'),zA=`${yY.getMinutes()}`.padStart(2,'0'),zB=`${yY.getSeconds()}`.padStart(2,'0');let zC=`${yZ}:${zA}:${zB}`;if(!confirm(`Sincronizar hora do servidor com a hora atual do navegador?\n\nHora do Navegador: ${zC}\n\nATENÃ‡ÃƒO: Isso irÃ¡ ajustar a hora do sistema do servidor!`))return;try{let zD=await bU('/api/time/sync',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({time:yY.toISOString()})});if(zD.ok){let zE=await zD.json();zE.warning?dF('warning',zE.message):dF('success',zE.message||'Hora do servidor sincronizada com sucesso!');await gA()}else try{let zF=await zD.json();if(zD.status===403&&zF.message)gD(zF.message,zF.requested_time);else{let zG=zF.error||zF.message||JSON.stringify(zF);console.error('Erro completo:',zG);dF('error',`Erro ao sincronizar: ${zG}`)}}catch{let zH=await zD.text();let zI=zH.match(/<title>.*?(\d+)\s+([^<]+)<\/title>/);zI?dF('error',`Erro ao sincronizar: ${zI[1]} - ${zI[2]}`):dF('error',`Erro ao sincronizar: Erro ${zD.status}`);console.error('Erro completo:',zH)}}catch(zJ){console.error('Erro ao sincronizar hora:',zJ);dF('error','Erro de conexÃ£o ao sincronizar hora do servidor.')}}function gD(zK,zL){let zM=zL?new Date(zL).toLocaleString('pt-BR'):'N/D';document.body.insertAdjacentHTML('beforeend',`
    <div id="modal-permission-error" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;">
      <div style="background: var(--cor-fundo); padding: 30px; border-radius: 12px; max-width: 650px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
        <h2 style="margin-top: 0; color: #e67e22;">ğŸ”’ PermissÃ£o NecessÃ¡ria</h2>
        <p style="color: var(--cor-texto); margin-bottom: 15px;">
          <strong>Hora solicitada:</strong> ${zM}
        </p>

        <div style="background: #34495e; color: #ecf0f1; padding: 15px; border-radius: 8px; margin-bottom: 20px; white-space: pre-wrap; font-family: monospace; font-size: 0.85rem; line-height: 1.6;">
${zK}
        </div>

        <div style="display: flex; gap: 10px; justify-content: center;">
          <button onclick="closePermissionErrorModal()" class="btn btn-primario">Entendido</button>
        </div>
      </div>
    </div>
  `)}function gE(){let zN=document.getElementById('modal-permission-error');zN?.remove()}window.addEventListener('load',()=>{gA();setInterval(gB,1000);let zO=document.getElementById('modal-alerta-sobrecarga');zO?.addEventListener('click',e=>e.target===zO&&dM());setInterval(gA,5*60*1000)});
